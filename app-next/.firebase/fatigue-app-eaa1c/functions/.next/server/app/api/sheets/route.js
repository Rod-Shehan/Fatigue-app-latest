"use strict";(()=>{var e={};e.id=219,e.ids=[219],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},62764:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>x,patchFetch:()=>y,requestAsyncStorage:()=>h,routeModule:()=>f,serverHooks:()=>w,staticGenerationAsyncStorage:()=>m});var s={};r.r(s),r.d(s,{GET:()=>c,POST:()=>g});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),u=r(95456),d=r(20728),l=r(88766);function p(e){return{id:e.id,driver_name:e.driverName,second_driver:e.secondDriver,driver_type:e.driverType,destination:e.destination,last_24h_break:e.last24hBreak,week_starting:e.weekStarting,days:JSON.parse(e.days),status:e.status,signature:e.signature,signed_at:e.signedAt?.toISOString()??null,created_by:e.createdById,created_date:e.createdAt.toISOString()}}async function c(){let e=await (0,u.gS)();if(!e)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let t=e.isManager?{}:{createdById:e.userId},r=(await d._.fatigueSheet.findMany({where:t,orderBy:{weekStarting:"desc"},take:50})).map(e=>p(e));return o.NextResponse.json(r)}catch(e){return o.NextResponse.json({error:"Unauthorized"},{status:401})}}async function g(e){let t=await (0,u.gS)();if(!t)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let r=await e.json(),{driver_name:s,second_driver:a,driver_type:n,destination:i,week_starting:u,days:c,status:g,signature:f,signed_at:h}=r;if(!u||!Array.isArray(c))return o.NextResponse.json({error:"week_starting and days required"},{status:400});let m=(s??"").trim()||"Draft";if((0,l.Q)(u)){if(!m||"Draft"===m)return o.NextResponse.json({error:"Set the driver name before creating a sheet for next week."},{status:400});let e=(0,l.Sx)(),t=await d._.fatigueSheet.findFirst({where:{weekStarting:e,driverName:m}});if(!t)return o.NextResponse.json({error:`Complete and sign the sheet for the week of ${e} before starting the next week.`,code:"PREVIOUS_WEEK_INCOMPLETE",week_starting:e},{status:400});if("completed"!==t.status)return o.NextResponse.json({error:`Complete and sign the sheet for the week of ${e} before starting the next week.`,code:"PREVIOUS_WEEK_INCOMPLETE",week_starting:e,sheet_id:t.id},{status:400})}let w=await d._.fatigueSheet.create({data:{driverName:m,secondDriver:a??null,driverType:n??"solo",destination:i??null,last24hBreak:r.last_24h_break??null,weekStarting:u,days:JSON.stringify(c),status:g??"draft",signature:f??null,signedAt:h?new Date(h):null,createdById:t.userId}});return o.NextResponse.json(p(w))}catch(e){return console.error("Sheet create error:",e),o.NextResponse.json({error:e instanceof Error?e.message:"Failed to create sheet"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sheets/route",pathname:"/api/sheets",filename:"route",bundlePath:"app/api/sheets/route"},resolvedPagePath:"C:\\Users\\r_she\\Documents\\Fatigue app\\app-next\\src\\app\\api\\sheets\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:h,staticGenerationAsyncStorage:m,serverHooks:w}=f,x="/api/sheets/route";function y(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:m})}},95456:(e,t,r)=>{r.d(t,{Ad:()=>d,Lz:()=>o,SC:()=>l,gS:()=>u});var s=r(75571),a=r(13539),n=r(53797),i=r(20728);let o={adapter:(0,a.N)(i._),session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},providers:[(0,n.Z)({name:"Email and password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){let t=e?.email,r=e?.password;if(!t||!r)return null;let s=void 0;if(s&&r===s){let e=await i._.user.findUnique({where:{email:t}});return e||(e=await i._.user.create({data:{email:t,name:t.split("@")[0]}})),{id:e.id,email:e.email,name:e.name}}return null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}};async function u(){let e=await (0,s.getServerSession)(o),t=e?.user&&"id"in e.user?e.user.id:void 0;return t?{session:e,userId:t,isManager:!!await l()}:null}function d(e,t){return!!t.isManager||e.createdById===t.userId}async function l(){let e=await (0,s.getServerSession)(o),t=e?.user?e.user.id:void 0;if(!t)return null;let r=await i._.user.findUnique({where:{id:t},select:{id:!0,email:!0,name:!0,role:!0}});return r?"manager"!==r.role&&await i._.user.findFirst({where:{role:"manager"},select:{id:!0}})?null:{session:e,user:r}:null}},20728:(e,t,r)=>{r.d(t,{_:()=>a});let s=require("@prisma/client"),a=globalThis.prisma??new s.PrismaClient({log:["error"]})},88766:(e,t,r)=>{function s(){let e=new Date,t=e.getDay(),r=new Date(e);return r.setDate(e.getDate()-t),i(r)}function a(e){let[t,r,s]=e.split("-").map(Number),a=new Date(t,r-1,s);return a.setDate(a.getDate()-7),i(a)}function n(e){return e>s()}function i(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${s}`}function o(e,t){let[r,s,a]=e.split("-").map(Number),n=new Date(r,s-1,a);return n.setDate(n.getDate()+t),i(n)}r.d(t,{GT:()=>a,Q:()=>n,Sx:()=>s,uQ:()=>o})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,637,972],()=>r(62764));module.exports=s})();