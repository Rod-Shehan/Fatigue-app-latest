"use strict";(()=>{var e={};e.id=885,e.ids=[885],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},68926:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>_,patchFetch:()=>b,requestAsyncStorage:()=>x,routeModule:()=>k,serverHooks:()=>S,staticGenerationAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{POST:()=>w});var o=r(49303),i=r(88716),a=r(60670),s=r(87070),l=r(95456),u=r(88766);function p(e){return .5*(e||[]).filter(Boolean).length}function h(e){return p(e.work_time)>0||(e.events?.some(e=>"work"===e.type)??!1)}function c(e){let t=e||[],r=0,n=0;for(let e=0;e<t.length;e++)t[e]?r=Math.max(r,++n):n=0;return .5*r}function g(e,t){let r=e||[],n=0,o=0,i=2*t;for(let e=0;e<r.length;e++)r[e]?o++:(o>=i&&n++,o=0);return o>=i&&n++,n}function d(e,t){let r=e.work_time||Array(48).fill(!1),n=t.work_time||Array(48).fill(!1),o=0;for(let e=47;e>=0&&!r[e];e--)o++;for(let e=0;e<48&&!n[e];e++)o++;return o}function f(e,t,r,n){return e<n?(0,u.uQ)(r,5+e):(0,u.uQ)(t,e-n)}let m=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function y(e,t){return e.flatMap(e=>(e[t]||Array(48).fill(!1)).slice(0,48))}async function w(e){if(!await (0,l.gS)())return s.NextResponse.json({error:"Unauthorized"},{status:401});try{let{days:t,driverType:r="solo",prevWeekDays:n,last24hBreak:o,weekStarting:i,prevWeekStarting:a}=await e.json();if(!Array.isArray(t))return s.NextResponse.json({error:"days must be an array"},{status:400});let l=function(e,t){let r=[],{driverType:n="solo",prevWeekDays:o,last24hBreak:i,weekStarting:a,prevWeekStarting:s}=t;!function(e,t){e.forEach((e,r)=>{let n=m[r],o=p(e.work_time),i=p(e.breaks);if(0===o+i+p(e.non_work))return;let a=e.events||[];if(a.length>1){let e=0,r=null,o=[];for(let i=0;i<a.length;i++){let s=a[i],l=a[i+1];if(!l)continue;let u=Math.floor((new Date(l.time).getTime()-new Date(s.time).getTime())/6e4);if("work"===s.type){if(o.length>0){let i=o.reduce((e,t)=>e+t,0),a=o.filter(e=>e>=10).length;i>=20&&a>=1?e=0:t.push({type:"violation",iconKey:"Coffee",day:n,message:"20 min break for 5h work not met"}),o.length=0,r=null}(e+=u)>300&&(t.push({type:"violation",iconKey:"AlertTriangle",day:n,message:"More than 5h work without valid break"}),e=0)}else"break"===s.type?(r||(r=s.time),o.push(u)):(o.length=0,r=null,e=0)}}else o>=5&&0===i&&t.push({type:"warning",iconKey:"Coffee",day:n,message:"20 min break for ea 5 hours work time - 10 min minimum x 2"})})}(e,r);let l=(o||[]).map(e=>({...e,work_time:e.work_time||Array(48).fill(!1),breaks:e.breaks||Array(48).fill(!1),non_work:e.non_work||Array(48).fill(!1)})),u=[...l.slice(-3),...e],w=Math.min(3,l.length);"two_up"===n?function(e,t,r){let n=y(e,"non_work"),o=y(e,"work_time"),i=y(e,"breaks"),a=e=>{let t=Math.floor(e/48),n=t-r;return n<0?`prev+${t+1}`:m[n]??`D${t+1}`};if(n.length>=48)for(let e=0;e<=n.length-48;e++){let r=e+48,s=n.slice(e,r).filter(Boolean).length,l=o.slice(e,r).filter(Boolean).length+i.slice(e,r).filter(Boolean).length,u=.5*s;if(.5*l>=16&&u<7){t.push({type:"violation",iconKey:"Moon",day:a(r-1),message:"Need ≥7h non-work in rolling 24h"});break}}if(n.length>=96)for(let e=0;e<=n.length-96;e++){let r=n.slice(e,e+96);if(1>g(r,7)&&r.some((t,r)=>o[e+r]||i[e+r])){t.push({type:"warning",iconKey:"Moon",day:a(e+96-1),message:"Need ≥1 block of ≥7 continuous hrs non-work in any rolling 48 hrs (Two-Up rule)"});break}}let s=e.slice(r),l=s.reduce((e,t)=>e+p(t.non_work),0),u=c(s.flatMap(e=>e.non_work||Array(48).fill(!1)));l>0&&l<48&&t.push({type:"warning",iconKey:"TrendingUp",day:"7-day",message:`Need ≥48 hrs non-work in 7 days (current: ${l}h) — Two-Up rule`}),l>=48&&u<24&&t.push({type:"warning",iconKey:"Moon",day:"7-day",message:`48hrs non-work must include ≥24 continuous hrs (longest: ${u}h) — Two-Up rule`})}(u,r,w):function(e,t,r,n){if(!e.some(h))return;e.forEach((e,o)=>{if(o<r||!h(e))return;let i=o-r,a=m[i]||`Day${i+1}`,s=p(e.work_time)+p(e.breaks)+p(e.non_work);if(0===s)return;let l=c(e.non_work),u=f(o,n?.weekStarting??"",n?.prevWeekStarting??"",r);(!n?.last24hBreak||!(u<n.last24hBreak)||h(e))&&!(n?.last24hBreak&&u===n.last24hBreak)&&s>=12&&l>0&&l<7&&t.push({type:"violation",iconKey:"Moon",day:a,message:"Need ≥7 continuous hrs non-work"})});let o=function(e,t){if(0===e.length)return[];if(1===e.length)return[[0]];let{weekStarting:r="",prevWeekStarting:n="",prevCount:o=0,last24hBreak:i}=t??{},a=[],s=0;for(let t=0;t<e.length-1;t++){let l=d(e[t],e[t+1]),u=i&&r&&(f(t,r,n,o)===i||f(t+1,r,n,o)===i);(l>=48||u)&&(a.push(Array.from({length:t-s+1},(e,t)=>s+t)),s=t+1)}return a.push(Array.from({length:e.length-s},(e,t)=>s+t)),a}(e,{weekStarting:n?.weekStarting,prevWeekStarting:n?.prevWeekStarting,prevCount:r,last24hBreak:n?.last24hBreak}),i=e=>{let t=e-r;return t<0?`prev+${e+1}`:m[t]??`D${e+1}`};for(let a of o){let o=a.map(t=>e[t]),s=y(o,"non_work"),l=y(o,"work_time"),u=y(o,"breaks"),p=0,c=0;for(let e=0;e<s.length;e++){let g=Math.min(Math.floor(e/48),o.length-1);if(!h(o[g]??{})){p=0,c=0;continue}let d=l[e]||u[e];if(s[e])c++,p=0;else if(d){if(c>=14&&(p=0),c=0,++p>34){let e=a[g],o=f(e,n?.weekStarting??"",n?.prevWeekStarting??"",r);if(n?.last24hBreak&&o===n.last24hBreak){p=0;continue}t.push({type:"violation",iconKey:"Clock",day:i(e),message:"More than 17h between 7-hr rest breaks"});break}}else c=0}}let a=n?.weekStarting??"",s=n?.prevWeekStarting??"";for(let n of o){let o=n.map(t=>e[t]),l=y(o,"non_work"),u=y(o,"work_time"),p=y(o,"breaks"),h=e=>i(n[Math.min(Math.floor(e/48),n.length-1)]);if(l.length>=144){let e=l.length-144,o=e+144-1,i=n[Math.min(Math.floor(o/48),n.length-1)],c=(o%48+1)*30,d=Math.floor(c/60),m=c%60,y=24===d?"24:00":`${String(d).padStart(2,"0")}:${String(m).padStart(2,"0")}`,w=f(i,a,s,r),k=w?new Date(w+"T12:00:00").toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"}):"",x=k?` — 72h window ending ${k} at ${y}`:"",v=l.slice(e,e+144),S=.5*v.filter(Boolean).length,_=g(v,7);v.some((t,r)=>u[e+r]||p[e+r])&&(S<27?t.push({type:"warning",iconKey:"TrendingUp",day:h(o),message:`Need ≥27 hrs non-work in any rolling 72hr period (24h non-work resets this rule; this window: ${S}h)${x}`}):_<3&&t.push({type:"warning",iconKey:"Moon",day:h(o),message:`Need ≥3 blocks of ≥7 continuous hrs non-work in any rolling 72hrs (24h non-work resets; found: ${_})${x}`}))}}}(u,r,w,{weekStarting:a,prevWeekStarting:s,last24hBreak:i});let k=e.reduce((e,t)=>e+p(t.work_time),0);if(l.reduce((e,t)=>e+p(t.work_time),0),l.length>0){let t=[...l,...e];for(let e of function(e){if(0===e.length)return[];if(1===e.length)return[[0]];let t=[],r=0;for(let n=0;n<e.length-1;n++)d(e[n],e[n+1])>=96&&(t.push(Array.from({length:n-r+1},(e,t)=>r+t)),r=n+1);return t.push(Array.from({length:e.length-r},(e,t)=>r+t)),t}(t)){let n=e.reduce((e,r)=>e+p(t[r].work_time),0);n>168?r.push({type:"violation",iconKey:"TrendingUp",day:"14-day",message:"14-day work exceeds 168h"}):n>140&&r.push({type:"warning",iconKey:"TrendingUp",day:"14-day",message:`${n}h work in this period — approaching 168h limit (14-day rule resets after ≥48h continuous non-work)`})}}else k>168?r.push({type:"violation",iconKey:"TrendingUp",day:"14-day",message:"14-day work exceeds 168h"}):k>84&&r.push({type:"warning",iconKey:"TrendingUp",day:"14-day",message:`${k}h this week — no previous sheet found to check full 14-day total`});return r}(t,{driverType:r,prevWeekDays:n??null,last24hBreak:o,weekStarting:i,prevWeekStarting:a});return s.NextResponse.json({results:l})}catch(e){return s.NextResponse.json({error:e instanceof Error?e.message:"Compliance check failed"},{status:500})}}let k=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/compliance/check/route",pathname:"/api/compliance/check",filename:"route",bundlePath:"app/api/compliance/check/route"},resolvedPagePath:"C:\\Users\\r_she\\Documents\\Fatigue app\\app-next\\src\\app\\api\\compliance\\check\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:x,staticGenerationAsyncStorage:v,serverHooks:S}=k,_="/api/compliance/check/route";function b(){return(0,a.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:v})}},95456:(e,t,r)=>{r.d(t,{Ad:()=>u,Lz:()=>s,SC:()=>p,gS:()=>l});var n=r(75571),o=r(13539),i=r(53797),a=r(20728);let s={adapter:(0,o.N)(a._),session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},providers:[(0,i.Z)({name:"Email and password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){let t=e?.email,r=e?.password;if(!t||!r)return null;let n=void 0;if(n&&r===n){let e=await a._.user.findUnique({where:{email:t}});return e||(e=await a._.user.create({data:{email:t,name:t.split("@")[0]}})),{id:e.id,email:e.email,name:e.name}}return null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}};async function l(){let e=await (0,n.getServerSession)(s),t=e?.user&&"id"in e.user?e.user.id:void 0;return t?{session:e,userId:t,isManager:!!await p()}:null}function u(e,t){return!!t.isManager||e.createdById===t.userId}async function p(){let e=await (0,n.getServerSession)(s),t=e?.user?e.user.id:void 0;if(!t)return null;let r=await a._.user.findUnique({where:{id:t},select:{id:!0,email:!0,name:!0,role:!0}});return r?"manager"!==r.role&&await a._.user.findFirst({where:{role:"manager"},select:{id:!0}})?null:{session:e,user:r}:null}},20728:(e,t,r)=>{r.d(t,{_:()=>o});let n=require("@prisma/client"),o=globalThis.prisma??new n.PrismaClient({log:["error"]})},88766:(e,t,r)=>{function n(){let e=new Date,t=e.getDay(),r=new Date(e);return r.setDate(e.getDate()-t),a(r)}function o(e){let[t,r,n]=e.split("-").map(Number),o=new Date(t,r-1,n);return o.setDate(o.getDate()-7),a(o)}function i(e){return e>n()}function a(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),n=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${n}`}function s(e,t){let[r,n,o]=e.split("-").map(Number),i=new Date(r,n-1,o);return i.setDate(i.getDate()+t),a(i)}r.d(t,{GT:()=>o,Q:()=>i,Sx:()=>n,uQ:()=>s})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,637,972],()=>r(68926));module.exports=n})();