"use strict";(()=>{var e={};e.id=651,e.ids=[651],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},68195:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>S,requestAsyncStorage:()=>w,routeModule:()=>h,serverHooks:()=>m,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{DELETE:()=>f,GET:()=>c,PATCH:()=>g});var n=r(49303),a=r(88716),i=r(60670),o=r(87070),u=r(95456),d=r(20728),l=r(88766);function p(e){return{id:e.id,driver_name:e.driverName,second_driver:e.secondDriver,driver_type:e.driverType,destination:e.destination,last_24h_break:e.last24hBreak,week_starting:e.weekStarting,days:JSON.parse(e.days),status:e.status,signature:e.signature,signed_at:e.signedAt?.toISOString()??null,created_by:e.createdById,created_date:e.createdAt.toISOString()}}async function c(e,{params:t}){let r=await (0,u.gS)();if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let{id:e}=await t,s=await d._.fatigueSheet.findUnique({where:{id:e}});if(!s)return o.NextResponse.json({error:"Not found"},{status:404});if(!(0,u.Ad)(s,r))return o.NextResponse.json({error:"Forbidden"},{status:403});return o.NextResponse.json(p(s))}catch(e){return o.NextResponse.json({error:"Unauthorized"},{status:401})}}async function g(e,{params:t}){let r=await (0,u.gS)();if(!r)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let{id:s}=await t,n=await d._.fatigueSheet.findUnique({where:{id:s}});if(!n)return o.NextResponse.json({error:"Not found"},{status:404});if(!(0,u.Ad)(n,r))return o.NextResponse.json({error:"Forbidden"},{status:403});let{driver_name:a,second_driver:i,driver_type:c,destination:g,last_24h_break:f,week_starting:h,days:w,status:x,signature:m,signed_at:v}=await e.json();if(void 0!==h&&(0,l.Q)(h)){let e=await d._.fatigueSheet.findUnique({where:{id:s}});if(!e)return o.NextResponse.json({error:"Not found"},{status:404});let t=(void 0!==a?a:e.driverName)?.trim()||"";if(!t||"Draft"===t)return o.NextResponse.json({error:"Set the driver name before moving this sheet to next week."},{status:400});let r=(0,l.GT)(h),n=await d._.fatigueSheet.findFirst({where:{driverName:t,weekStarting:r}});if(!n||"completed"!==n.status)return o.NextResponse.json({error:`Complete and sign the sheet for the week of ${r} before starting the next week.`,code:"PREVIOUS_WEEK_INCOMPLETE",week_starting:r,sheet_id:n?.id},{status:400})}let S={};void 0!==a&&(S.driverName=a),void 0!==i&&(S.secondDriver=i),void 0!==c&&(S.driverType=c),void 0!==g&&(S.destination=g),void 0!==f&&(S.last24hBreak=f||null),void 0!==h&&(S.weekStarting=h),void 0!==w&&(S.days=JSON.stringify(w)),void 0!==x&&(S.status=x),void 0!==m&&(S.signature=m),void 0!==v&&(S.signedAt=v?new Date(v):null);let y=await d._.fatigueSheet.update({where:{id:s},data:S});return o.NextResponse.json(p(y))}catch(e){return o.NextResponse.json({error:"Not found or unauthorized"},{status:404})}}async function f(e,{params:t}){try{if(!await (0,u.SC)())return o.NextResponse.json({error:"Manager access required"},{status:403});let{id:e}=await t;return await d._.fatigueSheet.delete({where:{id:e}}),new o.NextResponse(null,{status:204})}catch(e){return o.NextResponse.json({error:"Not found or unauthorized"},{status:404})}}let h=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sheets/[id]/route",pathname:"/api/sheets/[id]",filename:"route",bundlePath:"app/api/sheets/[id]/route"},resolvedPagePath:"C:\\Users\\r_she\\Documents\\Fatigue app\\app-next\\src\\app\\api\\sheets\\[id]\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:x,serverHooks:m}=h,v="/api/sheets/[id]/route";function S(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:x})}},95456:(e,t,r)=>{r.d(t,{Ad:()=>d,Lz:()=>o,SC:()=>l,gS:()=>u});var s=r(75571),n=r(13539),a=r(53797),i=r(20728);let o={adapter:(0,n.N)(i._),session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},providers:[(0,a.Z)({name:"Email and password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){let t=e?.email,r=e?.password;if(!t||!r)return null;let s=void 0;if(s&&r===s){let e=await i._.user.findUnique({where:{email:t}});return e||(e=await i._.user.create({data:{email:t,name:t.split("@")[0]}})),{id:e.id,email:e.email,name:e.name}}return null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}};async function u(){let e=await (0,s.getServerSession)(o),t=e?.user&&"id"in e.user?e.user.id:void 0;return t?{session:e,userId:t,isManager:!!await l()}:null}function d(e,t){return!!t.isManager||e.createdById===t.userId}async function l(){let e=await (0,s.getServerSession)(o),t=e?.user?e.user.id:void 0;if(!t)return null;let r=await i._.user.findUnique({where:{id:t},select:{id:!0,email:!0,name:!0,role:!0}});return r?"manager"!==r.role&&await i._.user.findFirst({where:{role:"manager"},select:{id:!0}})?null:{session:e,user:r}:null}},20728:(e,t,r)=>{r.d(t,{_:()=>n});let s=require("@prisma/client"),n=globalThis.prisma??new s.PrismaClient({log:["error"]})},88766:(e,t,r)=>{function s(){let e=new Date,t=e.getDay(),r=new Date(e);return r.setDate(e.getDate()-t),i(r)}function n(e){let[t,r,s]=e.split("-").map(Number),n=new Date(t,r-1,s);return n.setDate(n.getDate()-7),i(n)}function a(e){return e>s()}function i(e){let t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${r}-${s}`}function o(e,t){let[r,s,n]=e.split("-").map(Number),a=new Date(r,s-1,n);return a.setDate(a.getDate()+t),i(a)}r.d(t,{GT:()=>n,Q:()=>a,Sx:()=>s,uQ:()=>o})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,637,972],()=>r(68195));module.exports=s})();