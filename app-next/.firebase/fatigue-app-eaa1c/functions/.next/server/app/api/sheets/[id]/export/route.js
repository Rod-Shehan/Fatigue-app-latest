"use strict";(()=>{var e={};e.id=671,e.ids=[671],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},77240:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>T,requestAsyncStorage:()=>y,routeModule:()=>k,serverHooks:()=>_,staticGenerationAsyncStorage:()=>F});var n={};r.r(n),r.d(n,{GET:()=>S});var i=r(49303),a=r(88716),s=r(60670),o=r(87070),l=r(95456),u=r(20728);let d=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],p=[30,30,30],c=[80,80,80],h=[240,240,240],g=[55,55,55],m=[115,115,115],x=[200,200,200],f=["Work","Breaks","Non-Work Time"];function w(e,t){if(!e||e.length<48)return[];let r=[],n=null;for(let i=0;i<48;i++){let a=30*i,s=(i+1)*30,o=!!e[i];o&&null===n&&(n=a),o||null===n||(r.push({startMin:n,endMin:Math.min(a,t)}),n=null),o&&47===i&&r.push({startMin:n,endMin:Math.min(s,t)})}return r}function M(e,t,r){let n={work_time:[],breaks:[],non_work:[]},i=new Date(t+"T00:00:00").getTime(),a=new Date(t+"T23:59:59").getTime();if(!e?.length)return r>0&&(n.non_work=[{startMin:0,endMin:r}]),n;let s=[];for(let t=0;t<e.length;t++){let o=e[t];if("stop"===o.type)continue;let l=Math.min(e[t+1]?new Date(e[t+1].time).getTime():Date.now(),a),u=Math.max(new Date(o.time).getTime(),i);if(u>=l)continue;let d=Math.floor((u-i)/6e4),p=Math.min(r,Math.ceil((l-i)/6e4));if(d>=p)continue;let c=p-d,h="break"===o.type&&c<10;"work"===o.type||h?(n.work_time.push({startMin:d,endMin:p}),s.push({startMin:d,endMin:p})):"break"===o.type&&(n.breaks.push({startMin:d,endMin:p}),s.push({startMin:d,endMin:p}))}return r>0&&(n.non_work=function(e,t){if(0===e.length)return[{startMin:0,endMin:t}];let r=[...e].sort((e,t)=>e.startMin-t.startMin),n=[];for(let e of r){let t=n[n.length-1];t&&e.startMin<=t.endMin?t.endMin=Math.max(t.endMin,e.endMin):n.push({startMin:e.startMin,endMin:e.endMin})}let i=[],a=0;for(let e of n)e.startMin>a&&i.push({startMin:a,endMin:e.startMin}),a=Math.max(a,e.endMin);return a<t&&i.push({startMin:a,endMin:t}),i}(s,r)),n}async function S(e,{params:t}){let n=await (0,l.gS)();if(!n)return o.NextResponse.json({error:"Unauthorized"},{status:401});try{let e;let{id:i}=await t,a=await u._.fatigueSheet.findUnique({where:{id:i}});if(!a)return o.NextResponse.json({error:"Sheet not found"},{status:404});if(!(0,l.Ad)(a,n))return o.NextResponse.json({error:"Forbidden"},{status:403});try{let t=a.days?JSON.parse(a.days):[];e=Array.isArray(t)?t:[]}catch{e=[]}let s={driver_name:a.driverName,second_driver:a.secondDriver,driver_type:a.driverType,destination:a.destination,week_starting:a.weekStarting,days:e,status:a.status,signature:a.signature,signed_at:a.signedAt?.toISOString()??null},{jsPDF:S}=await r.e(817).then(r.bind(r,17817)),k=new S({orientation:"portrait",unit:"mm",format:"a4"}),y=new Date().toISOString().slice(0,10),F=30;k.setFillColor(15,23,42),k.rect(0,0,210,24,"F"),k.setTextColor(255,255,255),k.setFontSize(14),k.setFont("helvetica","bold"),k.text("FATIGUE RECORD SHEET",14,11),k.setFontSize(8),k.setFont("helvetica","normal"),k.text("WA Commercial Driver Fatigue Management",14,18),k.text(`Generated: ${new Date().toLocaleString("en-AU",{timeZone:"Australia/Perth"})}`,196,18,{align:"right"});let _=(s.days||[]).slice(0,7);for(;_.length<7;)_.push({});if(_.forEach((e,t)=>{F>258&&(k.addPage(),F=20);let r=d[t]??`Day ${t+1}`,n=function(e,t){if(!e)return"—";let[r,n,i]=e.split("-").map(Number),a=new Date(r,n-1,i);a.setDate(a.getDate()+t);let s=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),l=String(a.getDate()).padStart(2,"0");return`${l}/${o}/${s}`}(s.week_starting,t),i=e.date||function(e,t){if(!e)return new Date().toISOString().slice(0,10);let[r,n,i]=e.split("-").map(Number),a=new Date(r,n-1,i+t);return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}(s.week_starting,t),a=function(e,t,r){let n=function(e,t){if(e>t)return 0;if(e<t)return 1440;let r=new Date(e+"T00:00:00").getTime();return Math.min(1440,Math.ceil((Date.now()-r)/6e4))}(t,r),i=e?.events||[],a=e?.work_time!=null&&e?.breaks!=null&&e?.non_work!=null;return i.length>0?M(i,t,n):a?{work_time:w(e.work_time.map((t,r)=>t&&!e.breaks[r]),1440),breaks:w(e.breaks,1440),non_work:w(e.non_work,n)}:M(void 0,t,n)}(e,i,y);k.setDrawColor(200,200,200),k.setFillColor(...h),k.rect(14,F-3,182,46.5,"FD"),F+=2,k.setFillColor(30,30,30),k.rect(16,F-3.5,5,5,"F"),k.setTextColor(255,255,255),k.setFont("helvetica","bold"),k.setFontSize(8),k.text(r.charAt(0),18.5,F+.2,{align:"center"}),k.setTextColor(...p),k.setFontSize(10),k.text(r,24,F),k.setFont("helvetica","normal"),k.setFontSize(9),k.setTextColor(...c),k.text(n,24,F+5);let o=e.truck_rego??"",l=e.destination??"",u=e.start_kms??null,S=e.end_kms??null,_=null!=u&&null!=S?Math.max(0,S-u):null,v=[];o&&v.push(`Rego: ${o}`),l&&v.push(l),null!=u&&v.push(`Start: ${u} km`),null!=S&&v.push(`End: ${S} km`),null!=_&&v.push(`Total: ${_} km`),v.length&&(k.setFontSize(8),k.text(v.join("  •  "),16,F+10)),F+=16,k.setFontSize(7),k.setTextColor(...c);for(let e=0;e<=24;e+=2){let t=36+e/24*142;k.text(String(e).padStart(2,"0"),t,F+2.8,{align:"center"})}F+=5,f.forEach((e,t)=>{let r=a[["work_time","breaks","non_work"][t]],n=r.reduce((e,t)=>e+(t.endMin-t.startMin),0),i=[g,m,x][t];k.setFont("helvetica","normal"),k.setFontSize(8),k.setTextColor(...c),k.text(e,35,F+2.8,{align:"right"}),k.setFillColor(230,230,230),k.rect(36,F,142,4,"F"),r.forEach(e=>{let t=e.startMin/1440*142,r=Math.max(.5,(e.endMin-e.startMin)/1440*142);k.setFillColor(...i),k.rect(36+t,F,r,4,"F")}),k.setDrawColor(200,200,200),k.rect(36,F,142,4,"S"),k.setFont("helvetica","bold"),k.setFontSize(8),k.setTextColor(...n>0?p:c),k.text(function(e){if(0===e)return"—";let t=Math.floor(e/60),r=e%60;return 0===r?`${t}h`:`${t}h ${r}m`}(n),180,F+2.8),F+=5.5}),F+=7}),F+=4,s.signature){F>220&&(k.addPage(),F=20),k.setTextColor(...p),k.setFont("helvetica","bold"),k.setFontSize(9),k.text("DRIVER SIGNATURE",14,F),F+=4,k.setDrawColor(200,200,200),k.rect(14,F,80,30);try{k.addImage(s.signature,"PNG",15,F+1,78,28)}catch{}s.signed_at&&(k.setFont("helvetica","normal"),k.setFontSize(8),k.setTextColor(...c),k.text(`Signed: ${new Date(s.signed_at).toLocaleString("en-AU",{timeZone:"Australia/Perth"})}`,14,F+34))}let v=k.output("arraybuffer"),T=new Date().toISOString().slice(0,16).replace("T","_").replace(/:/g,""),D=`fatigue-sheet-${(s.driver_name||"unknown").replace(/\s+/g,"-")}-${T}.pdf`;return new o.NextResponse(v,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":`attachment; filename="${D}"`}})}catch(e){return o.NextResponse.json({error:"Export failed"},{status:500})}}let k=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/sheets/[id]/export/route",pathname:"/api/sheets/[id]/export",filename:"route",bundlePath:"app/api/sheets/[id]/export/route"},resolvedPagePath:"C:\\Users\\r_she\\Documents\\Fatigue app\\app-next\\src\\app\\api\\sheets\\[id]\\export\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:y,staticGenerationAsyncStorage:F,serverHooks:_}=k,v="/api/sheets/[id]/export/route";function T(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:F})}},95456:(e,t,r)=>{r.d(t,{Ad:()=>u,Lz:()=>o,SC:()=>d,gS:()=>l});var n=r(75571),i=r(13539),a=r(53797),s=r(20728);let o={adapter:(0,i.N)(s._),session:{strategy:"jwt",maxAge:2592e3},pages:{signIn:"/login"},providers:[(0,a.Z)({name:"Email and password",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){let t=e?.email,r=e?.password;if(!t||!r)return null;let n=void 0;if(n&&r===n){let e=await s._.user.findUnique({where:{email:t}});return e||(e=await s._.user.create({data:{email:t,name:t.split("@")[0]}})),{id:e.id,email:e.email,name:e.name}}return null}})],callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id,e.email=t.email),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}};async function l(){let e=await (0,n.getServerSession)(o),t=e?.user&&"id"in e.user?e.user.id:void 0;return t?{session:e,userId:t,isManager:!!await d()}:null}function u(e,t){return!!t.isManager||e.createdById===t.userId}async function d(){let e=await (0,n.getServerSession)(o),t=e?.user?e.user.id:void 0;if(!t)return null;let r=await s._.user.findUnique({where:{id:t},select:{id:!0,email:!0,name:!0,role:!0}});return r?"manager"!==r.role&&await s._.user.findFirst({where:{role:"manager"},select:{id:!0}})?null:{session:e,user:r}:null}},20728:(e,t,r)=>{r.d(t,{_:()=>i});let n=require("@prisma/client"),i=globalThis.prisma??new n.PrismaClient({log:["error"]})}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[276,637,972],()=>r(77240));module.exports=n})();