(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[449],{2996:function(e,t,r){Promise.resolve().then(r.bind(r,6553))},6553:function(e,t,r){"use strict";r.d(t,{SheetDetail:function(){return eW}});var a=r(7437),n=r(2265),s=r(9827),l=r(1713),i=r(1770),o=r(7648),d=r(1837),c=r(1884),u=r(2381),m=r(535),h=r(3448);let x=(0,m.j)("inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function g(e){let{className:t,variant:r,...n}=e;return(0,a.jsx)("div",{className:(0,h.cn)(x({variant:r}),t),...n})}var f=r(3355),p=r(4986);let k=f.fC,b=f.h_,v=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)(f.aV,{ref:t,className:(0,h.cn)("fixed inset-0 z-50 bg-black/80",r),...n})});v.displayName=f.aV.displayName;let w=n.forwardRef((e,t)=>{let{className:r,children:n,...s}=e;return(0,a.jsxs)(b,{children:[(0,a.jsx)(v,{}),(0,a.jsxs)(f.VY,{ref:t,className:(0,h.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-900 p-6 shadow-lg sm:rounded-lg",r),...s,children:[n,(0,a.jsxs)(f.x8,{className:"absolute right-4 top-4 rounded-sm opacity-70 hover:opacity-100",children:[(0,a.jsx)(p.Z,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]})});w.displayName=f.VY.displayName;let y=e=>{let{className:t,...r}=e;return(0,a.jsx)("div",{className:(0,h.cn)("flex flex-col space-y-1.5 text-left",t),...r})},j=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)(f.Dx,{ref:t,className:(0,h.cn)("text-lg font-semibold",r),...n})}),N=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)(f.dk,{ref:t,className:(0,h.cn)("text-sm text-slate-500",r),...n})});var _=r(279),M=r(5060),D=r(3459),S=r(7928),T=r(1715),C=r(4491),E=r(4287),Z=r(5465),A=r(3289),L=r(1146),R=r(4376),z=r(8678),K=r(521),B=r(1597),U=r(5291),P=r(7350),W=r(6994),I=r(8012),O=r(3147);function F(e){return e?new Date(e+"T12:00:00").toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"}):""}function q(e){var t,r;let{sheetData:s,onChange:i,readOnly:o=!1}=e,c=(0,n.useRef)(null),[m,h]=(0,n.useState)(!1),[x,g]=(0,n.useState)(""),f=(e,t)=>{i({...s,[e]:t})},p=s.driver_type||"solo",b=!!(null===(t=s.last_24h_break)||void 0===t?void 0:t.trim()),{data:v=[]}=(0,l.a)({queryKey:["drivers"],queryFn:()=>d.h.drivers.list()}),D=v.filter(e=>e.is_active);return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold mr-2",children:"Driver Type"}),(0,a.jsxs)("div",{className:"flex rounded-lg border border-slate-200 dark:border-slate-600 overflow-hidden",children:[(0,a.jsx)("button",{type:"button",disabled:o,onClick:()=>f("driver_type","solo"),className:"px-4 py-1.5 text-xs font-bold transition-colors ".concat("solo"===p?"bg-slate-900 dark:bg-slate-600 text-white dark:text-slate-100":"bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-600"),children:"Solo"}),(0,a.jsx)("button",{type:"button",disabled:o,onClick:()=>f("driver_type","two_up"),className:"px-4 py-1.5 text-xs font-bold transition-colors border-l border-slate-200 dark:border-slate-600 ".concat("two_up"===p?"bg-slate-900 dark:bg-slate-600 text-white dark:text-slate-100":"bg-white dark:bg-slate-700 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-600"),children:"Two-Up"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsxs)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold flex items-center gap-1.5",children:[(0,a.jsx)(P.Z,{className:"w-3 h-3"})," Driver Name"]}),D.length>0?(0,a.jsxs)(U.Ph,{value:s.driver_name||"",onValueChange:e=>f("driver_name",e),disabled:o,children:[(0,a.jsx)(U.i4,{className:"h-9 font-medium",children:(0,a.jsx)(U.ki,{placeholder:"Select driver…"})}),(0,a.jsx)(U.Bw,{children:D.map(e=>(0,a.jsx)(U.Ql,{value:e.name,children:e.name},e.id))})]}):(0,a.jsx)(_.I,{value:s.driver_name||"",onChange:e=>f("driver_name",e.target.value),placeholder:"Full name (no drivers added yet)",className:"h-9 font-medium",disabled:o})]}),"two_up"===p&&(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsxs)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold flex items-center gap-1.5",children:[(0,a.jsx)(W.Z,{className:"w-3 h-3"})," Second Driver *"]}),D.length>0?(0,a.jsxs)(U.Ph,{value:null!==(r=s.second_driver)&&void 0!==r?r:"",onValueChange:e=>f("second_driver",e),disabled:o,children:[(0,a.jsx)(U.i4,{className:"h-9 border-amber-300",children:(0,a.jsx)(U.ki,{placeholder:"Required for Two-Up"})}),(0,a.jsxs)(U.Bw,{children:[(0,a.jsx)(U.Ql,{value:"",children:"— None —"}),D.map(e=>(0,a.jsx)(U.Ql,{value:e.name,children:e.name},e.id))]})]}):(0,a.jsx)(_.I,{value:s.second_driver||"",onChange:e=>f("second_driver",e.target.value),placeholder:"Required for Two-Up",className:"h-9 border-amber-300 focus:border-amber-400",disabled:o})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsxs)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold flex items-center gap-1.5",children:[(0,a.jsx)(I.Z,{className:"w-3 h-3"})," Destination"]}),(0,a.jsx)(_.I,{value:s.destination||"",onChange:e=>f("destination",e.target.value),placeholder:"Destination",className:"h-9",disabled:o})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsx)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold",children:"Last 24 Hour Break"}),b?(0,a.jsxs)("div",{className:"h-9 flex flex-col justify-center rounded-md border border-slate-200 dark:border-slate-600 bg-slate-50 dark:bg-slate-800 px-3",children:[(0,a.jsx)("p",{className:"text-sm font-medium text-slate-800 dark:text-slate-200 font-mono",children:F(s.last_24h_break)}),(0,a.jsx)("p",{className:"text-[10px] text-slate-400 dark:text-slate-500",children:"Locked for this sheet"})]}):(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("input",{ref:c,type:"date",className:"absolute opacity-0 w-0 h-0 pointer-events-none","aria-hidden":!0,defaultValue:s.week_starting||"",onChange:e=>{let t=e.target.value;t&&(g(t),h(!0))}}),(0,a.jsxs)(u.z,{type:"button",variant:"outline",size:"sm",disabled:o,onClick:()=>{var e,t,r,a;return null!==(a=null===(t=c.current)||void 0===t?void 0:null===(e=t.showPicker)||void 0===e?void 0:e.call(t))&&void 0!==a?a:null===(r=c.current)||void 0===r?void 0:r.click()},className:"h-9 w-full justify-start gap-2 border-amber-300 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 hover:bg-amber-100 dark:hover:bg-amber-800/50 hover:border-amber-400 dark:hover:border-amber-600 font-medium",children:[(0,a.jsx)(O.Z,{className:"w-4 h-4 text-amber-600"}),"Set last 24h break"]}),(0,a.jsx)(k,{open:m,onOpenChange:e=>{h(e),e||g("")},children:(0,a.jsxs)(w,{className:"sm:max-w-sm",children:[(0,a.jsxs)(y,{children:[(0,a.jsx)(j,{children:"Confirm last 24 hour break"}),(0,a.jsx)(N,{children:"Set this date as your last 24 hour break? Once set, it cannot be changed for this sheet."})]}),x&&(0,a.jsx)("p",{className:"text-sm font-medium text-slate-800 font-mono",children:F(x)}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end pt-2",children:[(0,a.jsx)(u.z,{type:"button",variant:"outline",size:"sm",onClick:()=>{h(!1),g("")},children:"Cancel"}),(0,a.jsx)(u.z,{type:"button",size:"sm",onClick:()=>{f("last_24h_break",x),h(!1),g("")},className:"bg-slate-900 hover:bg-slate-800",children:"Confirm"})]})]})})]})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsx)(M._,{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold",children:"Week Starting"}),(0,a.jsx)(_.I,{type:"date",value:s.week_starting||"",onChange:e=>f("week_starting",e.target.value),className:"h-9 font-mono",disabled:o})]})]})]})}var V=r(5176),Q=r(5366),Y=r(9674);function H(e){let t=(0,Y._P)();if(e>t)return 0;if(e<t)return 1440;let r=new Date(e+"T00:00:00").getTime();return Math.min(1440,Math.ceil((Date.now()-r)/6e4))}function X(e,t){if(!e||e.length<48)return[];let r=[],a=null;for(let n=0;n<48;n++){let s=30*n,l=(n+1)*30,i=!!e[n];i&&null===a&&(a=s),i||null===a||(r.push({startMin:a,endMin:Math.min(s,t)}),a=null),i&&47===n&&r.push({startMin:a,endMin:Math.min(l,t)})}return r}function J(e,t){let r={work_time:[],breaks:[],non_work:[]},a=new Date(t+"T00:00:00").getTime(),n=new Date(t+"T23:59:59").getTime(),s=H(t);if(!(null==e?void 0:e.length))return s>0&&(r.non_work=[{startMin:0,endMin:s}]),r;let l=[];for(let t=0;t<e.length;t++){let i=e[t],o=e[t+1];if("stop"===i.type)continue;let d=Math.min(o?new Date(o.time).getTime():Date.now(),n),c=Math.max(new Date(i.time).getTime(),a);if(c>=d)continue;let u=Math.floor((c-a)/6e4),m=Math.ceil((d-a)/6e4);if(u>=(m=Math.min(m,s)))continue;let h=m-u,x="break"===i.type&&null!=o&&h<10;"work"===i.type||x?(r.work_time.push({startMin:u,endMin:m}),l.push({startMin:u,endMin:m})):"break"===i.type&&(r.breaks.push({startMin:u,endMin:m}),l.push({startMin:u,endMin:m}))}return s>0&&(r.non_work=function(e,t){if(0===e.length)return[{startMin:0,endMin:t}];let r=[...e].sort((e,t)=>e.startMin-t.startMin),a=[];for(let e of r){let t=a[a.length-1];t&&e.startMin<=t.endMin?t.endMin=Math.max(t.endMin,e.endMin):a.push({startMin:e.startMin,endMin:e.endMin})}let n=[],s=0;for(let e of a)e.startMin>s&&n.push({startMin:s,endMin:e.startMin}),s=Math.max(s,e.endMin);return s<t&&n.push({startMin:s,endMin:t}),n}(l,s)),r}function $(e){let{dayData:t}=e,r=t.events||[],n=t.date||(0,Y._P)(),s=H(n),l=null!=t.work_time&&null!=t.breaks&&null!=t.non_work,i=r.length>0?J(r,n):l?{work_time:X(t.work_time.map((e,r)=>e&&!t.breaks[r]),1440),breaks:X(t.breaks,1440),non_work:X(t.non_work,s)}:J(r,n),o=Array.from({length:13},(e,t)=>2*t);return(0,a.jsxs)("div",{className:"select-none",children:[(0,a.jsx)("div",{className:"relative h-4 mb-1",style:{marginLeft:72},children:o.map(e=>(0,a.jsx)("span",{className:"absolute text-[9px] font-mono text-slate-300 dark:text-slate-500 -translate-x-1/2",style:{left:"".concat(e/24*100,"%")},children:String(e).padStart(2,"0")},e))}),(0,a.jsx)("div",{className:"space-y-1.5",children:Q.t.map(e=>{let t=i[e.key],r=t.reduce((e,t)=>e+(t.endMin-t.startMin),0);return(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-[68px] shrink-0 text-[10px] font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wide text-right",children:e.label}),(0,a.jsxs)("div",{className:"relative flex-1 h-5 bg-slate-100 dark:bg-slate-700 rounded overflow-hidden",children:[t.map((t,r)=>(0,a.jsx)("div",{className:"absolute top-0 h-full rounded-sm opacity-90",style:{left:"".concat(t.startMin/1440*100,"%"),width:"".concat(Math.max((t.endMin-t.startMin)/1440*100,.2),"%"),backgroundColor:e.color}},r)),o.slice(1,-1).map(e=>(0,a.jsx)("div",{className:"absolute top-0 h-full border-l border-white/40 pointer-events-none",style:{left:"".concat(e/24*100,"%")}},e))]}),(0,a.jsx)("span",{className:"w-14 shrink-0 text-right text-[11px] font-bold font-mono text-slate-600 dark:text-slate-300",children:r>0?function(e){let t=Math.floor(e/60),r=e%60;return 0===r?"".concat(t,"h"):"".concat(t,"h ").concat(r,"m")}(r):(0,a.jsx)("span",{className:"text-slate-300 dark:text-slate-500",children:"—"})})]},e.key)})})]})}let G=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];function ee(e){var t,r,n,s;let{dayIndex:l,dayData:i,onUpdate:o,weekStart:d,regos:c=[],readOnly:u=!1}=e,m=(e,t)=>{o(l,{...i,[e]:t})},h=null!=i.end_kms&&null!=i.start_kms?Math.max(0,i.end_kms-i.start_kms):0;return(0,a.jsxs)(K.E.div,{initial:{opacity:0,y:12},animate:{opacity:1,y:0},transition:{delay:.04*l},className:"bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-3 md:p-5",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mb-3",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-8 h-8 rounded-lg bg-slate-900 dark:bg-slate-600 text-white dark:text-slate-200 flex items-center justify-center text-xs font-bold",children:null===(t=G[l])||void 0===t?void 0:t.charAt(0)}),(0,a.jsxs)("div",{children:[(0,a.jsx)("p",{className:"text-sm font-bold text-slate-800 dark:text-slate-100",children:G[l]}),(0,a.jsx)("p",{className:"text-[11px] text-slate-400 dark:text-slate-500 font-mono",children:(()=>{if(!d)return"";let e=new Date(d);return e.setDate(e.getDate()+l),e.toLocaleDateString("en-AU",{day:"2-digit",month:"2-digit",year:"numeric"})})()})]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2 ml-auto",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)(V.Z,{className:"w-3.5 h-3.5 text-slate-400 dark:text-slate-500 shrink-0"}),(0,a.jsxs)(U.Ph,{value:(null===(r=i.truck_rego)||void 0===r?void 0:r.trim())||"__none__",onValueChange:e=>m("truck_rego","__none__"===e?"":e),disabled:u,children:[(0,a.jsx)(U.i4,{className:"w-28 h-7 text-xs font-mono px-2 [&>span]:line-clamp-1",children:(0,a.jsx)(U.ki,{placeholder:"Rego"})}),(0,a.jsxs)(U.Bw,{children:[(0,a.jsx)(U.Ql,{value:"__none__",className:"text-slate-400 font-mono",children:"— Select rego —"}),(()=>{var e;let t=c.map(e=>e.label),r=null===(e=i.truck_rego)||void 0===e?void 0:e.trim();return r&&!t.includes(r)&&t.unshift(r),t.map(e=>(0,a.jsx)(U.Ql,{value:e,className:"font-mono",children:e},e))})()]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)(I.Z,{className:"w-3.5 h-3.5 text-slate-400 dark:text-slate-500"}),(0,a.jsx)(_.I,{placeholder:"Destination",value:i.destination||"",onChange:e=>m("destination",e.target.value),className:"w-32 min-w-[8rem] h-7 text-xs",disabled:u})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsxs)(M._,{className:"text-[10px] text-slate-400 dark:text-slate-500 uppercase",children:["Start km",(null===(n=i.truck_rego)||void 0===n?void 0:n.trim())?" *":""]}),(0,a.jsx)(_.I,{type:"number",placeholder:"0",value:null!==(s=i.start_kms)&&void 0!==s?s:"",onChange:e=>m("start_kms",e.target.value?Number(e.target.value):null),className:"w-20 h-7 text-xs font-mono",disabled:u})]}),h>0&&(0,a.jsxs)("span",{className:"text-[10px] font-mono text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800 px-2 py-0.5 rounded",children:[h," km"]})]})]}),(0,a.jsx)($,{dayData:{...i,date:d?(0,Y.uQ)(d,l):(0,Y._P)()}})]})}var et=r(2306),er=r(2032),ea=r(572),en=r(1475),es=r(6275),el=r(8614);function ei(e){var t;return(null!==(t=null==e?void 0:e.filter(Boolean).length)&&void 0!==t?t:0)/2}let eo=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function ed(e,t,r){if("14-day"===e)return"in the last 14 days";let a=r&&e.match(/^prev\+(\d+)$/);if(a){let e=parseInt(a[1],10);return ec((0,Y.uQ)(r,4+e))}let n=eo.indexOf(e);return n>=0&&t?ec((0,Y.uQ)(t,n)):e}function ec(e){return new Date(e+"T12:00:00").toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short"})}let eu={Coffee:et.Z,AlertTriangle:er.Z,Moon:ea.Z,Clock:en.Z,TrendingUp:es.Z,CheckCircle2:E.Z};function em(e){let{days:t,driverType:r,prevWeekDays:n,weekStarting:s,prevWeekStarting:l,complianceResults:i,complianceLoading:o}=e,d=null!=i?i:[],c=d.filter(e=>"violation"===e.type),u=d.filter(e=>"warning"===e.type),m=t.reduce((e,t)=>e+ei(t.work_time),0),h=t.reduce((e,t)=>e+ei(t.breaks),0),x=t.reduce((e,t)=>e+ei(t.non_work),0),g=(n||[]).reduce((e,t)=>e+ei(t.work_time),0),f="two_up"===r;return(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-bold ".concat(f?"bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-200":"bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300"),children:f?"\uD83D\uDC65 Two-Up Rules":"\uD83D\uDC64 Solo Rules"}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-2",children:[(0,a.jsxs)("div",{className:"rounded-lg p-3 text-center ".concat(Q.N.work.statsCard),children:[(0,a.jsx)("p",{className:"text-[10px] uppercase tracking-wider font-semibold ".concat(Q.N.work.statsLabel),children:"Work"}),(0,a.jsxs)("p",{className:"text-xl font-bold font-mono ".concat(Q.N.work.statsValue),children:[m,"h"]}),n&&n.length>0&&(0,a.jsxs)("p",{className:"text-[10px] text-blue-400 font-mono",children:["14d: ",m+g,"h"]})]}),(0,a.jsxs)("div",{className:"rounded-lg p-3 text-center ".concat(Q.N.break.statsCard),children:[(0,a.jsx)("p",{className:"text-[10px] uppercase tracking-wider font-semibold ".concat(Q.N.break.statsLabel),children:"Breaks"}),(0,a.jsxs)("p",{className:"text-xl font-bold font-mono ".concat(Q.N.break.statsValue),children:[h,"h"]})]}),(0,a.jsxs)("div",{className:"rounded-lg p-3 text-center ".concat(Q.N.rest.statsCard),children:[(0,a.jsx)("p",{className:"text-[10px] uppercase tracking-wider font-semibold ".concat(Q.N.rest.statsLabel),children:"Non-Work Time"}),(0,a.jsx)("p",{className:"text-[9px] text-slate-400 mt-0.5",children:"all time not work or break"}),(0,a.jsxs)("p",{className:"text-xl font-bold font-mono ".concat(Q.N.rest.statsValue),children:[x,"h"]})]})]}),(0,a.jsxs)("div",{className:"rounded-lg p-2.5 ".concat(Q.N.rest.statsCard," border border-emerald-100 dark:border-emerald-800"),children:[(0,a.jsx)("p",{className:"text-[10px] uppercase tracking-wider font-semibold text-emerald-600 dark:text-emerald-400 mb-1.5",children:"Non-Work Time rules"}),(0,a.jsxs)("ul",{className:"space-y-0.5 text-[11px] text-slate-600 dark:text-slate-400",children:[(0,a.jsx)("li",{children:"• All time not logged as work or break is counted as non-work time."}),(0,a.jsx)("li",{children:"• Starts when no shift is live, but only after the 24 hour break is set, and only before the current date and time."}),(0,a.jsx)("li",{children:"• Retrospective only — never shown or recorded after the current time on any day or shift."}),(0,a.jsx)("li",{children:"• End Shift sets recording to non-work; no separate button needed."})]})]}),n&&n.length>0&&(0,a.jsx)("p",{className:"text-[10px] text-slate-400 italic",children:"↑ Previous week's sheet linked for 14-day checks"}),(!n||0===n.length)&&(0,a.jsx)("p",{className:"text-[10px] text-slate-300 italic",children:"No previous week sheet found — 14-day check is partial"}),o&&(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-lg p-3",children:[(0,a.jsx)(D.Z,{className:"w-5 h-5 text-slate-500 dark:text-slate-400 shrink-0 animate-spin"}),(0,a.jsx)("span",{className:"text-sm text-slate-600 dark:text-slate-300",children:"Checking compliance…"})]}),!o&&i&&0===d.length&&(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-lg p-3",children:[(0,a.jsx)(E.Z,{className:"w-5 h-5 text-emerald-500 dark:text-emerald-400 shrink-0"}),(0,a.jsx)("span",{className:"text-sm font-medium text-emerald-700 dark:text-emerald-200",children:"All compliant — no issues detected"})]}),(0,a.jsx)(el.M,{children:c.length>0&&(0,a.jsxs)(K.E.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-1.5",children:[(0,a.jsxs)("p",{className:"text-[10px] uppercase tracking-wider text-red-500 dark:text-red-400 font-bold",children:["Violations (",c.length,")"]}),c.map((e,t)=>{let r=eu[e.iconKey];return(0,a.jsxs)("div",{className:"flex items-start gap-2 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg p-2.5",children:[r&&(0,a.jsx)(r,{className:"w-4 h-4 text-red-500 dark:text-red-400 mt-0.5 shrink-0"}),(0,a.jsxs)("p",{className:"text-xs text-red-700 dark:text-red-200",children:[e.message," — ",ed(e.day,s,l)]})]},t)})]})}),(0,a.jsx)(el.M,{children:u.length>0&&(0,a.jsxs)(K.E.div,{initial:{opacity:0},animate:{opacity:1},className:"space-y-1.5",children:[(0,a.jsxs)("p",{className:"text-[10px] uppercase tracking-wider text-amber-500 dark:text-amber-400 font-bold",children:["Warnings (",u.length,")"]}),u.map((e,t)=>{let r=eu[e.iconKey];return(0,a.jsxs)("div",{className:"flex items-start gap-2 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-800 rounded-lg p-2.5",children:[r&&(0,a.jsx)(r,{className:"w-4 h-4 text-amber-500 dark:text-amber-400 mt-0.5 shrink-0"}),(0,a.jsxs)("p",{className:"text-xs text-amber-700 dark:text-amber-200",children:[e.message,e.message.includes("72h window ending")?"":" — ".concat(ed(e.day,s,l))]})]},t)})]})}),(0,a.jsxs)("div",{className:"pt-2 border-t border-slate-100 dark:border-slate-700",children:[(0,a.jsxs)("p",{className:"text-[10px] uppercase tracking-wider text-slate-400 font-semibold mb-2",children:["WA OSH Reg 3.132 — ",f?"Two-Up":"Solo"," Rules"]}),f?(0,a.jsxs)("ul",{className:"space-y-1 text-[11px] text-slate-500 dark:text-slate-400",children:[(0,a.jsx)("li",{children:"• 20 min break for ea 5 hours work time - 10 min minimum x 2"}),(0,a.jsx)("li",{children:"• ≥7 hrs non-work in any rolling 24 hrs (can be in moving vehicle)"}),(0,a.jsx)("li",{children:"• ≥1 block of ≥7 continuous hrs non-work in any rolling 48 hrs (not in moving vehicle)"}),(0,a.jsx)("li",{children:"• ≥48 hrs non-work per 7 days (incl. ≥24 continuous hrs)"}),(0,a.jsx)("li",{children:"• Max 168 hrs work in any 14-day period (rolling; resets after ≥48h continuous non-work)"})]}):(0,a.jsxs)("ul",{className:"space-y-1 text-[11px] text-slate-500 dark:text-slate-400",children:[(0,a.jsx)("li",{children:"• 20 min break for ea 5 hours work time - 10 min minimum x 2"}),(0,a.jsx)("li",{children:"• ≥7 continuous hrs non-work time required"}),(0,a.jsx)("li",{children:"• Max 17 hrs elapsed time between 7-hr rest breaks (24h non-work resets)"}),(0,a.jsx)("li",{children:"• ≥27 hrs non-work in any rolling 72 hrs (incl. 3\xd7 ≥7hr blocks; 24h non-work resets)"}),(0,a.jsx)("li",{children:"• Max 168 hrs work in any 14-day period (rolling; resets after ≥48h continuous non-work)"})]})]})]})}var eh=r(7677),ex=r(2360);function eg(e){let{open:t,onConfirm:r,onCancel:s,driverName:l}=e,i=(0,n.useRef)(null),[o,d]=(0,n.useState)(!1),[c,m]=(0,n.useState)(!1),h=(0,n.useRef)(null);(0,n.useEffect)(()=>{t&&m(!1)},[t]);let x=(e,t)=>{let r=t.getBoundingClientRect(),a=t.width/r.width,n=t.height/r.height;return"touches"in e?{x:(e.touches[0].clientX-r.left)*a,y:(e.touches[0].clientY-r.top)*n}:{x:(e.clientX-r.left)*a,y:(e.clientY-r.top)*n}},g=e=>{e.preventDefault();let t=i.current;t&&(h.current=x(e,t),d(!0))},f=e=>{if(e.preventDefault(),!o||!h.current)return;let t=i.current;if(!t)return;let r=t.getContext("2d");if(!r)return;let a=x(e,t);r.beginPath(),r.moveTo(h.current.x,h.current.y),r.lineTo(a.x,a.y),r.strokeStyle="#1e293b",r.lineWidth=2.5,r.lineCap="round",r.lineJoin="round",r.stroke(),h.current=a,m(!0)},p=e=>{null==e||e.preventDefault(),d(!1),h.current=null};return(0,a.jsx)(k,{open:t,onOpenChange:e=>{e||s()},children:(0,a.jsxs)(w,{className:"max-w-md",children:[(0,a.jsxs)(y,{children:[(0,a.jsxs)(j,{className:"flex items-center gap-2",children:[(0,a.jsx)(eh.Z,{className:"w-4 h-4"})," Driver Signature"]}),(0,a.jsx)(N,{children:l?"".concat(l," — please sign below to confirm this weekly record is accurate."):"Please sign below to confirm this weekly record is accurate."})]}),(0,a.jsxs)("div",{className:"border-2 border-slate-300 dark:border-slate-600 rounded-lg overflow-hidden bg-white dark:bg-slate-800 relative",style:{touchAction:"none"},children:[(0,a.jsx)("canvas",{ref:i,width:460,height:160,className:"w-full h-40 cursor-crosshair",onMouseDown:g,onMouseMove:f,onMouseUp:p,onMouseLeave:()=>p(),onTouchStart:g,onTouchMove:f,onTouchEnd:p}),!c&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:(0,a.jsx)("span",{className:"text-slate-300 text-sm font-medium select-none",children:"Sign here"})}),(0,a.jsx)("div",{className:"absolute bottom-8 left-6 right-6 border-b border-dashed border-slate-300 pointer-events-none"})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-1",children:[(0,a.jsxs)(u.z,{variant:"ghost",size:"sm",onClick:()=>{let e=i.current;if(!e)return;let t=e.getContext("2d");t&&(t.clearRect(0,0,e.width,e.height),m(!1))},className:"text-slate-500 gap-1",children:[(0,a.jsx)(ex.Z,{className:"w-3.5 h-3.5"})," Clear"]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)(u.z,{variant:"outline",size:"sm",onClick:s,children:"Cancel"}),(0,a.jsxs)(u.z,{size:"sm",onClick:()=>{let e=i.current;e&&r(e.toDataURL("image/png"))},disabled:!c,className:"bg-emerald-600 hover:bg-emerald-700 text-white gap-1",children:[(0,a.jsx)(E.Z,{className:"w-3.5 h-3.5"}),"Confirm & Complete"]})]})]}),(0,a.jsx)("p",{className:"text-[10px] text-slate-400 text-center -mt-1",children:"By signing, the driver confirms this record is true and correct — WA Heavy Vehicle National Law"})]})})}var ef=r(8954),ep=r(9547);let ek={work:ef.Z,break:et.Z,rest:ea.Z,stop:z.Z},eb={work:"Work",break:"Break",rest:"Rest",stop:"End Shift"},ev=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function ew(e){let{days:t,currentDayIndex:r,weekStarting:s,onLogEvent:l,onEndShiftRequest:i,leadingIcon:o,workRelevantComplianceMessages:d}=e,[c,u]=(0,n.useState)(null),[m,h]=(0,n.useState)(null),x=(0,n.useRef)(null),[,g]=(0,n.useState)(0);(0,n.useEffect)(()=>{let e=setInterval(()=>g(e=>e+1),1e4);return()=>clearInterval(e)},[]);let f=t[r],p=(null==f?void 0:f.events)||[],k=p[p.length-1],b=k&&"stop"!==k.type?k.type:null,v=b&&k?Math.floor((Date.now()-new Date(k.time).getTime())/6e4):0,w=b&&"stop"!==b?"work"===b?{type:"work",elapsed:v,target:300,pct:Math.min(100,v/300*100),remaining:Math.max(0,300-v),color:Q.N.work.hex,label:"5h"}:"break"===b?{type:"break",elapsed:v,target:20,pct:Math.min(100,v/20*100),remaining:Math.max(0,20-v),color:Q.N.break.hex,label:"20m"}:null:null,y=(()=>{if(!s)return ev[r];let e=new Date(s);return e.setDate(e.getDate()+r),e.toLocaleDateString("en-AU",{weekday:"short",day:"numeric",month:"short"})})(),j=(()=>{if(!s)return ev[r];let e=new Date(s);return e.setDate(e.getDate()+r),e.toLocaleDateString("en-AU",{day:"numeric",month:"short"})})(),N=(0,n.useCallback)(()=>{x.current&&(clearTimeout(x.current),x.current=null),u(null)},[]);(0,n.useEffect)(()=>{N(),h(null)},[r,N]);let _=e=>{if("work"!==e)return null;let t=[];for(let e=p.length-1;e>=0&&"break"===p[e].type;e--){let r=e+1<p.length?new Date(p[e+1].time).getTime():Date.now(),a=new Date(p[e].time).getTime();t.unshift(Math.floor((r-a)/6e4))}let r=t.reduce((e,t)=>e+t,0),a=t.filter(e=>e>=10).length;return r<20||a<1?"20 min break for ea 5 hours work time - 10 min minimum x 2":null},M=e=>{if("work"!==e||"break"!==b||!k)return null;let t=new Date(k.time).getTime();return Math.floor((Date.now()-t)/6e4)>=10?null:"Breaks under 10 minutes are automatically counted as work time."},D=()=>{if(null!==b&&"stop"!==b)return null;let e=null;for(let s=0;s<=r;s++){var a,n;for(let r of null!==(n=null===(a=t[s])||void 0===a?void 0:a.events)&&void 0!==n?n:[])if("stop"===r.type){let t=new Date(r.time).getTime();(null===e||t>e)&&(e=t)}}return null===e||(Date.now()-e)/36e5>=7?null:"Less than 7 hours non-work time since last shift. Starting work may not meet rest requirements."},S=e=>{if(e!==b){if(c===e){if("work"===e){let t=_(e);if(t){h({message:t,confirmLabel:"Log work anyway",subtext:"This will log work now.",onConfirm:()=>{h(null),N(),l(r,e)},onCancel:N});return}}if(N(),"stop"===e&&i){i(r);return}l(r,e);return}if("work"===e){let t=M(e);if(t){h({message:t,confirmLabel:"Finish break anyway",subtext:"Tap Work again within a few seconds to confirm.",onConfirm:()=>{h(null),u("work"),x.current&&clearTimeout(x.current),x.current=setTimeout(N,2500)}});return}let r=D();if(r){h({message:r,confirmLabel:"Start shift anyway",subtext:"Tap Work again within a few seconds to confirm.",onConfirm:()=>{h(null),u("work"),x.current&&clearTimeout(x.current),x.current=setTimeout(N,2500)}});return}if(null==d?void 0:d.length){h({message:1===d.length?d[0]:"Logging work now may affect these compliance rules:\n\n• "+d.join("\n\n• "),confirmLabel:null===b||"stop"===b?"Start shift anyway":"Log work anyway",subtext:"Tap Work again within a few seconds to confirm.",onConfirm:()=>{h(null),u("work"),x.current&&clearTimeout(x.current),x.current=setTimeout(N,2500)}});return}}u(e),x.current&&clearTimeout(x.current),x.current=setTimeout(N,2500)}},T=(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-x-2 gap-y-0.5 text-base min-w-0",children:[null!=o&&(0,a.jsx)("span",{className:"flex items-center justify-center text-slate-500 dark:text-slate-400 shrink-0","aria-hidden":!0,children:o}),(0,a.jsx)("span",{className:"text-xs uppercase tracking-wider text-slate-400 dark:text-slate-500 font-semibold shrink-0",children:"Today"}),(0,a.jsxs)("span",{className:"font-bold text-slate-800 dark:text-slate-100 tabular-nums shrink-0",children:[(0,a.jsx)("span",{className:"hidden sm:inline",children:y}),(0,a.jsx)("span",{className:"sm:hidden",children:j})]}),b&&(0,a.jsxs)("span",{className:"text-slate-500 dark:text-slate-400 shrink-0",children:[(0,a.jsx)("span",{className:"hidden sm:inline",children:"— current activity: "}),(0,a.jsx)("span",{className:"sm:hidden",children:"\xb7 "}),(0,a.jsx)("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:b})]})]}),(0,a.jsx)("div",{className:"flex flex-wrap items-center justify-center gap-3",children:(0,a.jsxs)("div",{className:"inline-flex items-center gap-3 shrink-0",children:[(()=>{let e="work"===b?"break":"work",t=c===e,r=Q.N[e],s="work"===e&&(null===b||"stop"===b)?"Start shift":eb[e];return(0,a.jsxs)("button",{type:"button",onClick:()=>S(e),className:"flex items-center justify-center gap-4 px-10 py-5 rounded-2xl text-white text-lg font-bold transition-all duration-150 active:scale-95 shadow-lg min-h-[64px] min-w-[180px] shrink-0 ".concat(r.button," ").concat(t?"ring-2 ring-white ring-offset-2 ring-offset-slate-200 dark:ring-offset-slate-800 animate-pulse":""),children:[n.createElement(ek[e],{className:"w-8 h-8"}),t?"Tap again to log":s]})})(),(()=>{let e="stop",t=c===e,r=b===e,s=Q.N[e],l=t?"bg-red-500 hover:bg-red-600 disabled:bg-red-300":s.button;return(0,a.jsxs)("button",{type:"button",onClick:()=>S(e),disabled:r,className:"flex items-center justify-center gap-1.5 px-3 py-2 rounded-lg text-white text-xs font-bold transition-all duration-150 active:scale-95 disabled:opacity-40 disabled:cursor-not-allowed shadow-sm shrink-0 ".concat(l," ").concat(t?"ring-2 ring-white ring-offset-2 ring-offset-slate-200 dark:ring-offset-slate-800 animate-pulse":""),children:[n.createElement(ek[e],{className:"w-4 h-4"}),t?"Tap again to end shift":eb[e]]})})()]})}),w&&(0,a.jsxs)("div",{className:"pt-1",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2 mb-0.5",children:[(0,a.jsxs)("span",{className:"text-xs font-semibold text-slate-500 dark:text-slate-400 uppercase tracking-wider",children:["work"===w.type&&(()=>{let e=function(e,t){if(0===e.length)return null;let r=e[e.length-1];if("work"!==r.type)return null;let a=300,n=null;for(let r=e.length-1;r>=0;r--){let s=r===e.length-1?t:new Date(e[r+1].time).getTime(),l=Math.floor((s-new Date(e[r].time).getTime())/6e4);if("work"===e[r].type){if(a<=l){n=s-6e4*a;break}a-=l}}null==n&&(n=new Date(r.time).getTime());let s=!1;for(let r=0;r<e.length;r++){if("break"!==e[r].type)continue;let a=new Date(e[r].time).getTime(),l=r+1<e.length?new Date(e[r+1].time).getTime():t,i=Math.floor((l-a)/6e4),o=a<t&&l>n;if(i>=10&&o){s=!0;break}}return n+(300-(s?10:20))*6e4}(p,Date.now());return null!=e?"WORK — BREAK DUE BY ".concat(new Date(e).toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:!0})):"WORK — BREAK DUE"})(),"break"===w.type&&(()=>{let e=function(e,t){if(0===e.length)return null;let r=e[e.length-1];if("break"!==r.type)return null;let a=new Date(r.time).getTime(),n=300,s=null;for(let t=e.length-1;t>=0;t--){let r=t===e.length-1?a:new Date(e[t+1].time).getTime(),l=Math.floor((r-new Date(e[t].time).getTime())/6e4);if("work"===e[t].type){if(n<=l){s=r-6e4*n;break}n-=l}}if(null==s&&e.length>=2&&(s=new Date(e[e.length-2].time).getTime()),null==s)return null;let l=!1;for(let t=0;t<e.length;t++){if("break"!==e[t].type)continue;let r=new Date(e[t].time).getTime(),n=t+1<e.length?new Date(e[t+1].time).getTime():a;if(n>a)continue;let i=Math.floor((n-r)/6e4),o=r<a&&n>s;if(i>=10&&o){l=!0;break}}return a+6e4*(l?10:20)}(p,Date.now());return null!=e?"BREAK COMPLETE BY ".concat(new Date(e).toLocaleTimeString("en-AU",{hour:"numeric",minute:"2-digit",hour12:!0})):"BREAK — 20 min"})()]}),(0,a.jsx)("span",{className:"text-xs font-mono text-slate-600 dark:text-slate-300 tabular-nums",children:null})]}),(0,a.jsxs)("div",{className:"relative h-8 bg-slate-100 dark:bg-slate-700 rounded-lg overflow-hidden",children:[(0,a.jsxs)("div",{className:"absolute inset-0 rounded-lg",children:[(0,a.jsx)("div",{className:"absolute inset-y-0 left-0 rounded-lg transition-all duration-300",style:{width:"".concat(w.pct,"%"),backgroundColor:w.color}}),"work"===w.type&&[1,2,3,4].map(e=>(0,a.jsx)("div",{className:"absolute top-0 bottom-0 w-px bg-white/60",style:{left:"".concat(e/5*100,"%")},"aria-hidden":!0},e)),"break"===w.type&&[1,2,3].map(e=>(0,a.jsx)("div",{className:"absolute top-0 bottom-0 w-px bg-white/60",style:{left:"".concat(e/4*100,"%")},"aria-hidden":!0},e))]}),w.pct>0&&w.pct<100&&(0,a.jsx)("div",{className:"absolute top-1/2 w-2.5 h-2.5 -translate-y-1/2 -translate-x-1/2 rounded-full bg-black dark:bg-white border-2 border-slate-400 dark:border-slate-300 shadow-md pointer-events-none z-10",style:{left:"".concat(w.pct,"%")},title:"Current progress","aria-hidden":!0})]})]})]});return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"max-w-[1400px] mx-auto px-4 py-3 invisible pointer-events-none select-none flex items-start gap-3","aria-hidden":!0,children:[(0,a.jsx)("div",{className:"flex-1 min-w-0",children:T}),(0,a.jsx)("div",{className:"w-9 h-9 shrink-0"})]}),(0,a.jsxs)("div",{className:"fixed top-0 left-0 right-0 z-50 bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-700 shadow-md px-4 py-3",children:[(0,a.jsxs)("div",{className:"max-w-[1400px] mx-auto flex items-start gap-3",children:[(0,a.jsx)("div",{className:"flex-1 min-w-0",children:T}),(0,a.jsx)("div",{className:"shrink-0 pt-0.5",children:(0,a.jsx)(ep.T,{})})]}),m&&(0,a.jsx)("div",{className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/50","aria-modal":!0,role:"alertdialog","aria-labelledby":"work-warning-title",children:(0,a.jsxs)("div",{className:"mx-4 max-w-sm rounded-xl bg-white dark:bg-slate-800 border border-amber-300 dark:border-amber-600 shadow-xl p-4 space-y-3",children:[(0,a.jsx)("p",{id:"work-warning-title",className:"font-semibold text-amber-800 dark:text-amber-200",children:"⚠️ Work time rule"}),(0,a.jsx)("p",{className:"text-sm text-slate-700 dark:text-slate-300 whitespace-pre-line",children:m.message}),m.subtext&&(0,a.jsx)("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:m.subtext}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,a.jsx)("button",{type:"button",onClick:()=>{var e;null===(e=m.onCancel)||void 0===e||e.call(m),h(null)},className:"px-3 py-1.5 rounded-lg text-sm font-medium bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-slate-200 hover:bg-slate-300 dark:hover:bg-slate-500",children:"Cancel"}),(0,a.jsx)("button",{type:"button",onClick:()=>m.onConfirm(),className:"px-3 py-1.5 rounded-lg text-sm font-medium bg-amber-500 hover:bg-amber-600 text-white",children:m.confirmLabel})]})]})})]})]})}function ey(e,t,r,a){for(let n=0;n<a;){if(!r[n]){n++;continue}let s=n;for(;s<a&&r[s];)s++;let l=(s-n)*30<=30,i=n>0&&e[n-1],o=s<a&&e[s];if(l&&(i||o))for(let e=n;e<s;e++)t[e]=!0,r[e]=!1;n=s}return{work_time:e,breaks:t,non_work:r}}function ej(e,t,r){return(null==r?void 0:r.trim())&&t?e.map((e,a)=>(0,Y.uQ)(t,a)>=r||(e.work_time||[]).some(Boolean)?e:{...e,non_work:Array(48).fill(!1)}):e}function eN(e,t){let r=(0,Y._P)(),a=e.map(e=>({...e}));for(let n=0;n<e.length;n++){let e=n>0&&a[n-1].events||[],s=e[e.length-1],l=s&&("work"===s.type||"break"===s.type)?s.type:null,i=a[n].events||[],o=(0,Y.uQ)(t,n),d=new Date(o+"T00:00:00").getTime(),c=o===r,u=new Date(o+"T23:59:59").getTime(),m=Date.now(),h=c?Math.min(u,m):u,x=c?Math.min(48,Math.ceil((h-d)/18e5)):48,g=0;if(l){let e=i[0];g=e?Math.min(x,Math.max(0,Math.ceil((new Date(e.time).getTime()-d)/18e5))):x}let f=function(e,t,r){let a=Array(48).fill(!1),n=Array(48).fill(!1),s=Array(48).fill(!1),l=(0,Y._P)();if(t>l)return{work_time:a,breaks:n,non_work:s};let i=t===l,o=Date.now(),d=new Date(t+"T00:00:00").getTime(),c=new Date(t+"T23:59:59").getTime(),u=i?Math.min(c,o):c,m=i?Math.min(48,Math.ceil((u-d)/18e5)):48,{carryOverType:h,carryOverEndSlot:x=0}=null!=r?r:{};if(h&&x>0){let e=Math.min(x,m);for(let t=0;t<e;t++)"work"===h?a[t]=!0:n[t]=!0}if(!(null==e?void 0:e.length)){for(let e=0;e<m;e++)a[e]||n[e]||(s[e]=!0);return ey(a,n,s,m)}for(let t=0;t<e.length;t++){let r=e[t],s=e[t+1];if("stop"===r.type)continue;let l=new Date(r.time).getTime(),h=s?new Date(s.time).getTime():i?o:c,x=Math.max(l,d),g=Math.min(h,u),f=Math.floor((g-x)/6e4),p=Math.floor((x-d)/18e5),k=Math.ceil((g-d)/18e5),b="break"===r.type&&null!=s&&f<10;for(let e=Math.max(0,p);e<Math.min(m,k);e++)"work"===r.type||b?a[e]=!0:"break"===r.type&&(n[e]=!0)}for(let e=0;e<m;e++)a[e]||n[e]||(s[e]=!0);return ey(a,n,s,m)}(i.length?i:void 0,o,{carryOverType:null!=l?l:void 0,carryOverEndSlot:g||void 0});a[n]={...a[n],...f}}return a}function e_(e){return .5*(e||[]).filter(Boolean).length}function eM(e){var t,r;return e_(e.work_time)>0||null!==(r=null===(t=e.events)||void 0===t?void 0:t.some(e=>"work"===e.type))&&void 0!==r&&r}function eD(e){let t=e||[],r=0,a=0;for(let e=0;e<t.length;e++)t[e]?r=Math.max(r,++a):a=0;return .5*r}function eS(e,t){let r=e||[],a=0,n=0,s=2*t;for(let e=0;e<r.length;e++)r[e]?n++:(n>=s&&a++,n=0);return n>=s&&a++,a}function eT(e,t){let r=e.work_time||Array(48).fill(!1),a=t.work_time||Array(48).fill(!1),n=0;for(let e=47;e>=0&&!r[e];e--)n++;for(let e=0;e<48&&!a[e];e++)n++;return n}function eC(e,t,r,a){return e<a?(0,Y.uQ)(r,5+e):(0,Y.uQ)(t,e-a)}ef.Z,et.Z,ea.Z,z.Z;let eE=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];function eZ(e,t){return e.flatMap(e=>(e[t]||Array(48).fill(!1)).slice(0,48))}let eA=["non-work","7 continuous","7h ","17h","72","48 hrs","48hrs","168","14-day","rest"],eL={timeout:2500,maxAge:8e3,highAccuracy:!1};function eR(e){if(!("undefined"!=typeof navigator&&"geolocation"in navigator))return Promise.resolve(null);let{timeout:t=5e3,maxAge:r=1e4,highAccuracy:a=!0}=null!=e?e:{};return new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{var r;e({lat:t.coords.latitude,lng:t.coords.longitude,accuracy:null!==(r=t.coords.accuracy)&&void 0!==r?r:0})},()=>e(null),{enableHighAccuracy:a,timeout:t,maximumAge:r})})}function ez(e,t,r,a){let n=function(e,t,r){let a=null;for(let s=0;s<t&&s<e.length;s++){var n;let t=e[s];if((null!=(n=t.truck_rego)?n:"").trim().toLowerCase()!==(null!=r?r:"").trim().toLowerCase())continue;let l=t.end_kms;null!=l&&"number"==typeof l&&!Number.isNaN(l)&&(null===a||l>a)&&(a=l)}return a}(e,t,r);return null===n&&null===a?null:null===n?a:null===a?n:Math.max(n,a)}function eK(e,t,r,a,n,s){if(""===r.trim())return{valid:!0};let l=ez(e,t,r,s);if(null!=a&&null!=l&&a<l)return{valid:!1,message:"Start km (".concat(a,") cannot be lower than the last recorded end km for this rego (").concat(l,").")};if(null!=n){if(null!=l&&n<l)return{valid:!1,message:"End km (".concat(n,") cannot be lower than the last recorded end km for this rego (").concat(l,").")};if(null!=a&&n<a)return{valid:!1,message:"End km (".concat(n,") cannot be less than start km (").concat(a,").")}}return{valid:!0}}function eB(e){for(let a=0;a<e.length;a++){var t,r;let n=e[a],s=(null!==(t=n.truck_rego)&&void 0!==t?t:"").trim();if(""===s)continue;let l=n.start_kms,i=n.end_kms;if(null==l||"number"==typeof l&&Number.isNaN(l))return"Day ".concat(a+1,": start km is required when rego is set.");if(null==i||"number"==typeof i&&Number.isNaN(i))return"Day ".concat(a+1,": end km is required when rego is set. Use End Shift to record end km.");let o=eK(e,a,s,l,i,null);if(!o.valid)return null!==(r=o.message)&&void 0!==r?r:"Day ".concat(a+1,": invalid km.")}return null}let eU=()=>({day_label:"",date:"",truck_rego:"",destination:"",start_kms:void 0,end_kms:void 0,work_time:Array(48).fill(!1),breaks:Array(48).fill(!1),non_work:Array(48).fill(!1)});function eP(){let e=new Date,t=e.getDay(),r=new Date(e);return r.setDate(e.getDate()-t),r.toISOString().split("T")[0]}function eW(e){var t,r,m,h,x,f;let{sheetId:p}=e,b=(0,s.NL)(),[v,U]=(0,n.useState)({driver_name:"",second_driver:"",driver_type:"solo",destination:"",last_24h_break:"",week_starting:eP(),days:Array(7).fill(null).map(()=>eU()),status:"draft"}),[P,W]=(0,n.useState)(!1),[I,O]=(0,n.useState)(null),[F,V]=(0,n.useState)(!1),[Q,H]=(0,n.useState)(!1),[X,J]=(0,n.useState)(null),[$,G]=(0,n.useState)(""),[et,er]=(0,n.useState)(null),ea=(0,n.useRef)(v);ea.current=v;let en=(0,n.useRef)(null),es=(0,n.useRef)(null),el=(0,n.useRef)(null),[ei,eo]=(0,n.useState)(()=>Date.now());(0,n.useEffect)(()=>{let e=setInterval(()=>eo(Date.now()),6e4);return()=>clearInterval(e)},[]),(0,n.useEffect)(()=>{if(p)try{sessionStorage.setItem("fatigue-last-sheet-id",p)}catch(e){}},[p]);let ed=(0,n.useMemo)(()=>(function(e){if(!e)return new Date().getDay();let[t,r,a]=e.split("-").map(Number),n=new Date(t,r-1,a),s=new Date;return Math.max(0,Math.min(6,Math.round((new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime()-n.getTime())/864e5)))})(v.week_starting),[v.week_starting,ei]),{data:ec,isLoading:eu}=(0,l.a)({queryKey:["sheet",p],queryFn:()=>(0,c.r9)(p)}),{data:eh=[]}=(0,l.a)({queryKey:["sheets"],queryFn:()=>(0,c.Fy)()}),{data:ex=[]}=(0,l.a)({queryKey:["regos"],queryFn:()=>(0,c.OX)()});(0,n.useEffect)(()=>{if(ec){let e=ec.week_starting||eP();U({driver_name:ec.driver_name||"",second_driver:ec.second_driver||"",driver_type:ec.driver_type||"solo",destination:ec.destination||"",last_24h_break:ec.last_24h_break||"",week_starting:e,days:ej(eN((ec.days||[]).map(e=>({...eU(),...e})),e),e,ec.last_24h_break||void 0),status:ec.status||"draft",signature:ec.signature,signed_at:ec.signed_at})}},[ec]);let ef=(0,n.useMemo)(()=>{if(!v.driver_name||!v.week_starting)return null;let e=new Date(new Date(v.week_starting));e.setDate(e.getDate()-7);let t=e.toISOString().split("T")[0];return eh.find(e=>{var r,a;return e.id!==p&&(null===(r=e.driver_name)||void 0===r?void 0:r.toLowerCase())===(null===(a=v.driver_name)||void 0===a?void 0:a.toLowerCase())&&e.week_starting===t})||null},[eh,v.driver_name,v.week_starting,p]),ep=(0,n.useMemo)(()=>{var e,t;return{days:v.days,driverType:v.driver_type,prevWeekDays:null!==(e=null==ef?void 0:ef.days)&&void 0!==e?e:null,last24hBreak:v.last_24h_break||void 0,weekStarting:v.week_starting||void 0,prevWeekStarting:null!==(t=null==ef?void 0:ef.week_starting)&&void 0!==t?t:void 0}},[v.days,v.driver_type,v.last_24h_break,v.week_starting,ef]),{data:ek,isLoading:eb}=(0,l.a)({queryKey:["compliance",p,ep],queryFn:()=>d.h.compliance.check(ep),enabled:!!(null===(t=v.days)||void 0===t?void 0:t.length)}),ev=(null!==(h=null==ek?void 0:ek.results)&&void 0!==h?h:[]).some(e=>"violation"===e.type),ey=(0,n.useMemo)(()=>{var e,t,r;return(null===(e=v.days)||void 0===e?void 0:e.length)&&"completed"!==v.status?function(e,t,r,a){let n=function(e,t){let r=new Date((0,Y.uQ)(e,t)+"T00:00:00").getTime();return Math.max(0,Math.min(47,Math.floor((Date.now()-r)/18e5)))}(r,t);return(function(e,t){let r=[],{driverType:a="solo",prevWeekDays:n,last24hBreak:s,weekStarting:l,prevWeekStarting:i}=t;!function(e,t){e.forEach((e,r)=>{let a=eE[r],n=e_(e.work_time),s=e_(e.breaks);if(0===n+s+e_(e.non_work))return;let l=e.events||[];if(l.length>1){let e=0,r=null,n=[];for(let s=0;s<l.length;s++){let i=l[s],o=l[s+1];if(!o)continue;let d=Math.floor((new Date(o.time).getTime()-new Date(i.time).getTime())/6e4);if("work"===i.type){if(n.length>0){let s=n.reduce((e,t)=>e+t,0),l=n.filter(e=>e>=10).length;s>=20&&l>=1?e=0:t.push({type:"violation",iconKey:"Coffee",day:a,message:"20 min break for 5h work not met"}),n.length=0,r=null}(e+=d)>300&&(t.push({type:"violation",iconKey:"AlertTriangle",day:a,message:"More than 5h work without valid break"}),e=0)}else"break"===i.type?(r||(r=i.time),n.push(d)):(n.length=0,r=null,e=0)}}else n>=5&&0===s&&t.push({type:"warning",iconKey:"Coffee",day:a,message:"20 min break for ea 5 hours work time - 10 min minimum x 2"})})}(e,r);let o=(n||[]).map(e=>({...e,work_time:e.work_time||Array(48).fill(!1),breaks:e.breaks||Array(48).fill(!1),non_work:e.non_work||Array(48).fill(!1)})),d=[...o.slice(-3),...e],c=Math.min(3,o.length);"two_up"===a?function(e,t,r){let a=eZ(e,"non_work"),n=eZ(e,"work_time"),s=eZ(e,"breaks"),l=e=>{var t;let a=Math.floor(e/48),n=a-r;return n<0?"prev+".concat(a+1):null!==(t=eE[n])&&void 0!==t?t:"D".concat(a+1)};if(a.length>=48)for(let e=0;e<=a.length-48;e++){let r=e+48,i=a.slice(e,r).filter(Boolean).length,o=n.slice(e,r).filter(Boolean).length+s.slice(e,r).filter(Boolean).length,d=.5*i;if(.5*o>=16&&d<7){t.push({type:"violation",iconKey:"Moon",day:l(r-1),message:"Need ≥7h non-work in rolling 24h"});break}}if(a.length>=96)for(let e=0;e<=a.length-96;e++){let r=a.slice(e,e+96);if(1>eS(r,7)&&r.some((t,r)=>n[e+r]||s[e+r])){t.push({type:"warning",iconKey:"Moon",day:l(e+96-1),message:"Need ≥1 block of ≥7 continuous hrs non-work in any rolling 48 hrs (Two-Up rule)"});break}}let i=e.slice(r),o=i.reduce((e,t)=>e+e_(t.non_work),0),d=eD(i.flatMap(e=>e.non_work||Array(48).fill(!1)));o>0&&o<48&&t.push({type:"warning",iconKey:"TrendingUp",day:"7-day",message:"Need ≥48 hrs non-work in 7 days (current: ".concat(o,"h) — Two-Up rule")}),o>=48&&d<24&&t.push({type:"warning",iconKey:"Moon",day:"7-day",message:"48hrs non-work must include ≥24 continuous hrs (longest: ".concat(d,"h) — Two-Up rule")})}(d,r,c):function(e,t,r,a){var n,s,l,i,o;if(!e.some(eM))return;e.forEach((e,n)=>{var s,l;if(n<r||!eM(e))return;let i=n-r,o=eE[i]||"Day".concat(i+1),d=e_(e.work_time)+e_(e.breaks)+e_(e.non_work);if(0===d)return;let c=eD(e.non_work),u=eC(n,null!==(s=null==a?void 0:a.weekStarting)&&void 0!==s?s:"",null!==(l=null==a?void 0:a.prevWeekStarting)&&void 0!==l?l:"",r);(null==a||!a.last24hBreak||!(u<a.last24hBreak)||eM(e))&&!((null==a?void 0:a.last24hBreak)&&u===a.last24hBreak)&&d>=12&&c>0&&c<7&&t.push({type:"violation",iconKey:"Moon",day:o,message:"Need ≥7 continuous hrs non-work"})});let d=function(e,t){if(0===e.length)return[];if(1===e.length)return[[0]];let{weekStarting:r="",prevWeekStarting:a="",prevCount:n=0,last24hBreak:s}=null!=t?t:{},l=[],i=0;for(let t=0;t<e.length-1;t++){let o=eT(e[t],e[t+1]),d=s&&r&&(eC(t,r,a,n)===s||eC(t+1,r,a,n)===s);(o>=48||d)&&(l.push(Array.from({length:t-i+1},(e,t)=>i+t)),i=t+1)}return l.push(Array.from({length:e.length-i},(e,t)=>i+t)),l}(e,{weekStarting:null==a?void 0:a.weekStarting,prevWeekStarting:null==a?void 0:a.prevWeekStarting,prevCount:r,last24hBreak:null==a?void 0:a.last24hBreak}),c=e=>{var t;let a=e-r;return a<0?"prev+".concat(e+1):null!==(t=eE[a])&&void 0!==t?t:"D".concat(e+1)};for(let i of d){let o=i.map(t=>e[t]),d=eZ(o,"non_work"),u=eZ(o,"work_time"),m=eZ(o,"breaks"),h=0,x=0;for(let e=0;e<d.length;e++){let g=Math.min(Math.floor(e/48),o.length-1);if(!eM(null!==(n=o[g])&&void 0!==n?n:{})){h=0,x=0;continue}let f=u[e]||m[e];if(d[e])x++,h=0;else if(f){if(x>=14&&(h=0),x=0,++h>34){let e=i[g],n=eC(e,null!==(s=null==a?void 0:a.weekStarting)&&void 0!==s?s:"",null!==(l=null==a?void 0:a.prevWeekStarting)&&void 0!==l?l:"",r);if((null==a?void 0:a.last24hBreak)&&n===a.last24hBreak){h=0;continue}t.push({type:"violation",iconKey:"Clock",day:c(e),message:"More than 17h between 7-hr rest breaks"});break}}else x=0}}let u=null!==(i=null==a?void 0:a.weekStarting)&&void 0!==i?i:"",m=null!==(o=null==a?void 0:a.prevWeekStarting)&&void 0!==o?o:"";for(let a of d){let n=a.map(t=>e[t]),s=eZ(n,"non_work"),l=eZ(n,"work_time"),i=eZ(n,"breaks"),o=e=>c(a[Math.min(Math.floor(e/48),a.length-1)]);if(s.length>=144){let e=s.length-144,n=e+144-1,d=a[Math.min(Math.floor(n/48),a.length-1)],c=(n%48+1)*30,h=Math.floor(c/60),x=c%60,g=24===h?"24:00":"".concat(String(h).padStart(2,"0"),":").concat(String(x).padStart(2,"0")),f=eC(d,u,m,r),p=f?new Date(f+"T12:00:00").toLocaleDateString("en-AU",{day:"numeric",month:"short",year:"numeric"}):"",k=p?" — 72h window ending ".concat(p," at ").concat(g):"",b=s.slice(e,e+144),v=.5*b.filter(Boolean).length,w=eS(b,7);b.some((t,r)=>l[e+r]||i[e+r])&&(v<27?t.push({type:"warning",iconKey:"TrendingUp",day:o(n),message:"Need ≥27 hrs non-work in any rolling 72hr period (24h non-work resets this rule; this window: ".concat(v,"h)").concat(k)}):w<3&&t.push({type:"warning",iconKey:"Moon",day:o(n),message:"Need ≥3 blocks of ≥7 continuous hrs non-work in any rolling 72hrs (24h non-work resets; found: ".concat(w,")").concat(k)}))}}}(d,r,c,{weekStarting:l,prevWeekStarting:i,last24hBreak:s});let u=e.reduce((e,t)=>e+e_(t.work_time),0);if(o.reduce((e,t)=>e+e_(t.work_time),0),o.length>0){let t=[...o,...e];for(let e of function(e){if(0===e.length)return[];if(1===e.length)return[[0]];let t=[],r=0;for(let a=0;a<e.length-1;a++)eT(e[a],e[a+1])>=96&&(t.push(Array.from({length:a-r+1},(e,t)=>r+t)),r=a+1);return t.push(Array.from({length:e.length-r},(e,t)=>r+t)),t}(t)){let a=e.reduce((e,r)=>e+e_(t[r].work_time),0);a>168?r.push({type:"violation",iconKey:"TrendingUp",day:"14-day",message:"14-day work exceeds 168h"}):a>140&&r.push({type:"warning",iconKey:"TrendingUp",day:"14-day",message:"".concat(a,"h work in this period — approaching 168h limit (14-day rule resets after ≥48h continuous non-work)")})}}else u>168?r.push({type:"violation",iconKey:"TrendingUp",day:"14-day",message:"14-day work exceeds 168h"}):u>84&&r.push({type:"warning",iconKey:"TrendingUp",day:"14-day",message:"".concat(u,"h this week — no previous sheet found to check full 14-day total")});return r})(e.map((e,r)=>{var a;if(r!==t)return{...e};let s=[...null!==(a=e.work_time)&&void 0!==a?a:Array(48).fill(!1)];return n>=0&&n<s.length&&(s[n]=!0),{...e,work_time:s}}),{...a,weekStarting:r}).filter(e=>eA.some(t=>e.message.includes(t))).map(e=>e.message)}(v.days,ed,v.week_starting,{driverType:v.driver_type,prevWeekDays:null!==(t=null==ef?void 0:ef.days)&&void 0!==t?t:null,last24hBreak:v.last_24h_break||void 0,prevWeekStarting:null!==(r=null==ef?void 0:ef.week_starting)&&void 0!==r?r:void 0}):[]},[v.days,v.week_starting,v.driver_type,v.last_24h_break,v.status,ed,null==ef?void 0:ef.days,null==ef?void 0:ef.week_starting]),eW=(0,n.useCallback)(()=>{var e;null===(e=document.getElementById("compliance-check"))||void 0===e||e.scrollIntoView({behavior:"smooth",block:"start"})},[]),eI=(0,i.D)({mutationFn:async e=>(0,c.o_)(p,e),onSuccess:()=>{b.invalidateQueries({queryKey:["sheet",p]}),b.invalidateQueries({queryKey:["sheets"]}),W(!1),O(new Date)}});(0,n.useEffect)(()=>{if(P&&v.driver_name)return en.current&&clearTimeout(en.current),en.current=setTimeout(()=>{eI.mutate({driver_name:v.driver_name,second_driver:v.second_driver,driver_type:v.driver_type,destination:v.destination,last_24h_break:v.last_24h_break||void 0,week_starting:v.week_starting,days:v.days,status:v.status})},3e4),()=>{en.current&&clearTimeout(en.current)}},[v,P]);let eO=(0,n.useCallback)(e=>{U(t=>{let r={...t,...e};return{...r,days:ej(r.days,r.week_starting,r.last_24h_break||void 0)}}),W(!0)},[]),eF=(0,n.useCallback)((e,t)=>{U(r=>{let a=[...r.days];a[e]=t;let n=eN(a,r.week_starting);return{...r,days:ej(n,r.week_starting,r.last_24h_break||void 0)}}),W(!0)},[]),eq=(0,n.useCallback)((e,t)=>{U(r=>{let a=[...r.days],n=a[e],s=[...n.events||[],{time:new Date().toISOString(),type:t}];a[e]={...n,events:s};let l=eN(a,r.week_starting);return{...r,days:ej(l,r.week_starting,r.last_24h_break||void 0)}}),W(!0),eR(eL).then(t=>{t&&(U(r=>{let a=[...r.days],n=a[e],s=[...n.events||[]],l=s[s.length-1];return l&&(s[s.length-1]={...l,lat:t.lat,lng:t.lng,accuracy:t.accuracy}),a[e]={...n,events:s},{...r,days:a}}),W(!0))})},[]),eV=(0,n.useCallback)(async e=>{var t,r,a;let n=ea.current.days,s=n[e],l=null==s?void 0:s.start_kms;if(null==l||"number"==typeof l&&Number.isNaN(l)){window.alert("Please enter start km for today before ending the shift.");return}let i=(null!==(r=null==s?void 0:s.truck_rego)&&void 0!==r?r:"").trim(),o=null;if(i)try{o=(await d.h.sheets.regoMaxEndKms(i)).maxEndKms}catch(e){}let c=ez(n,e,i,o);if(null!=c&&l<c){window.alert("Start km (".concat(l,") cannot be lower than the last recorded end km for this rego (").concat(c,"). Please correct start km on the day card first."));return}er(null),G(String(null!==(a=null===(t=ea.current.days[e])||void 0===t?void 0:t.end_kms)&&void 0!==a?a:"")),J({dayIndex:e})},[]),eQ=(0,n.useCallback)(async()=>{var e,t,r;if(null==X)return;er(null);let a=X.dayIndex,n=$.trim();if(""===n){er("End km is required.");return}let s=Number(n);if(Number.isNaN(s)||s<0){er("Enter a valid end km (0 or greater).");return}let l=ea.current.days,i=l[a],o=null!==(e=null==i?void 0:i.start_kms)&&void 0!==e?e:null,c=(null!==(t=null==i?void 0:i.truck_rego)&&void 0!==t?t:"").trim(),u=null;if(c)try{u=(await d.h.sheets.regoMaxEndKms(c)).maxEndKms}catch(e){}let m=eK(l,a,c,o,s,u);if(!m.valid){er(null!==(r=m.message)&&void 0!==r?r:"Invalid km.");return}U(e=>{let t=[...e.days],r=t[a],n=[...r.events||[],{time:new Date().toISOString(),type:"stop"}];t[a]={...r,end_kms:s,events:n};let l=eN(t,e.week_starting);return{...e,days:ej(l,e.week_starting,e.last_24h_break||void 0)}}),W(!0),J(null),G(""),eR(eL).then(e=>{e&&(U(t=>{let r=[...t.days],n=r[a],s=[...n.events||[]],l=s[s.length-1];return l&&(s[s.length-1]={...l,lat:e.lat,lng:e.lng,accuracy:e.accuracy}),r[a]={...n,events:s},{...t,days:r}}),W(!0))})},[X,$]),eY=()=>{H(!1);let e=eB(v.days);if(e){window.alert(e);return}eI.mutate({driver_name:v.driver_name,second_driver:v.second_driver,driver_type:v.driver_type,destination:v.destination,last_24h_break:v.last_24h_break||void 0,week_starting:v.week_starting,days:v.days,status:v.status,signature:v.signature||void 0,signed_at:v.signed_at||void 0})};(0,n.useEffect)(()=>{if(!Q)return;let e=e=>{es.current&&!es.current.contains(e.target)&&H(!1)};return document.addEventListener("click",e),()=>document.removeEventListener("click",e)},[Q]);let eH=(0,n.useCallback)(()=>{H(!1),window.open(d.h.sheets.exportPdfUrl(p),"_blank")},[p]);return eu||!ec?(0,a.jsx)("div",{className:"flex items-center justify-center min-h-screen bg-slate-50 dark:bg-slate-950",children:(0,a.jsx)(D.Z,{className:"w-6 h-6 animate-spin text-slate-400"})}):(0,a.jsxs)("div",{className:"min-h-screen bg-slate-50 dark:bg-slate-950 pb-6",children:["completed"!==v.status&&(0,a.jsx)(ew,{days:v.days,currentDayIndex:ed,weekStarting:v.week_starting,onLogEvent:eq,onEndShiftRequest:eV,leadingIcon:(0,a.jsx)(S.Z,{className:"w-5 h-5"}),workRelevantComplianceMessages:ey}),(0,a.jsxs)("div",{className:"max-w-[1400px] mx-auto px-4 py-6",children:[(0,a.jsx)(B.m,{backHref:"/sheets",backLabel:"Your Sheets",title:"Fatigue Record",subtitle:"WA Commercial Driver Fatigue Management",actions:(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(o.default,{href:"/manager",className:"inline-flex items-center justify-center gap-1.5 shrink-0 h-8 rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 px-2.5 sm:px-3 text-xs font-medium text-slate-700 dark:text-slate-200 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors",children:[(0,a.jsx)(T.Z,{className:"w-3.5 h-3.5"}),"Manager"]}),(0,a.jsxs)(o.default,{href:"/sheets/".concat(p,"/shift-log"),className:"inline-flex items-center justify-center gap-1.5 shrink-0 h-8 rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 px-2.5 sm:px-3 text-xs font-medium text-slate-700 dark:text-slate-200 shadow-sm hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors",children:[(0,a.jsx)(C.Z,{className:"w-3.5 h-3.5"}),"Shift Log"]}),I&&!P&&(0,a.jsxs)("span",{className:"text-[10px] text-slate-400 flex items-center gap-1 shrink-0",children:[(0,a.jsx)(E.Z,{className:"w-3 h-3 text-emerald-400"}),(0,a.jsxs)("span",{className:"hidden sm:inline",children:["Saved ",I.toLocaleTimeString("en-AU",{hour:"2-digit",minute:"2-digit",hour12:!1})]})]}),P&&!eI.isPending&&(0,a.jsx)("span",{className:"text-[10px] text-amber-500 font-medium shrink-0",children:"Unsaved changes"}),"completed"===v.status&&(0,a.jsxs)(g,{variant:"outline",className:"border-emerald-300 text-emerald-600 flex items-center gap-1 shrink-0",children:[(0,a.jsx)(E.Z,{className:"w-3 h-3"})," Completed"]}),(0,a.jsx)("div",{className:"relative inline-flex shrink-0",ref:es,children:"completed"!==v.status?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(u.z,{onClick:eY,disabled:eI.isPending,size:"sm",className:"bg-slate-900 hover:bg-slate-800 text-white gap-1.5 text-xs rounded-r-none border-r border-slate-700",children:[eI.isPending?(0,a.jsx)(D.Z,{className:"w-3.5 h-3.5 animate-spin"}):(0,a.jsx)(Z.Z,{className:"w-3.5 h-3.5"}),"Save"]}),(0,a.jsx)(u.z,{type:"button",size:"sm",onClick:()=>H(e=>!e),className:"bg-slate-900 hover:bg-slate-800 text-white h-8 w-8 p-0 rounded-l-none border-slate-700","aria-label":"Save options",children:(0,a.jsx)(A.Z,{className:"w-3.5 h-3.5 transition-transform ".concat(Q?"rotate-180":"")})}),Q&&(0,a.jsxs)("div",{className:"absolute right-0 top-full z-50 mt-1 min-w-[180px] rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 py-1 shadow-lg",children:[(0,a.jsxs)("button",{type:"button",onClick:eY,disabled:eI.isPending,className:"flex w-full items-center gap-2 px-3 py-2 text-left text-xs text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700",children:[(0,a.jsx)(Z.Z,{className:"w-3.5 h-3.5"})," Save draft"]}),(0,a.jsxs)("button",{type:"button",onClick:()=>{H(!1);let e=eB(v.days);if(e){window.alert(e);return}V(!0)},className:"flex w-full items-center gap-2 px-3 py-2 text-left text-xs text-emerald-700 dark:text-emerald-300 hover:bg-emerald-50 dark:hover:bg-emerald-900/50",children:[(0,a.jsx)(E.Z,{className:"w-3.5 h-3.5"})," Save & mark complete"]}),(0,a.jsxs)("button",{type:"button",onClick:e=>{e.preventDefault(),e.stopPropagation(),eH()},className:"flex w-full items-center gap-2 px-3 py-2 text-left text-xs text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 border-t border-slate-200 dark:border-slate-600",children:[(0,a.jsx)(L.Z,{className:"w-3.5 h-3.5"}),"Export PDF"]})]})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(u.z,{onClick:eY,disabled:eI.isPending,size:"sm",className:"bg-slate-900 hover:bg-slate-800 text-white gap-1.5 text-xs",children:[eI.isPending?(0,a.jsx)(D.Z,{className:"w-3.5 h-3.5 animate-spin"}):(0,a.jsx)(Z.Z,{className:"w-3.5 h-3.5"}),"Save"]}),(0,a.jsxs)(u.z,{type:"button",onClick:eH,size:"sm",variant:"outline",className:"gap-1.5 text-xs border-slate-300 dark:border-slate-600",children:[(0,a.jsx)(L.Z,{className:"w-3.5 h-3.5"}),"Export PDF"]})]})}),(0,a.jsx)("div",{className:"w-full basis-full h-0","aria-hidden":!0}),(0,a.jsxs)("button",{type:"button",onClick:eW,className:"inline-flex items-center gap-1.5 shrink-0 h-8 sm:h-9 rounded-md border px-2.5 sm:px-3 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-1 ".concat(ev?"border-amber-300 dark:border-amber-700 bg-amber-50 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 hover:bg-amber-100 dark:hover:bg-amber-800/50":"border-emerald-300 dark:border-emerald-700 bg-emerald-50 dark:bg-emerald-900/40 text-emerald-800 dark:text-emerald-200 hover:bg-emerald-100 dark:hover:bg-emerald-800/50"),title:ev?"View compliance — issues found":"View compliance — OK","aria-label":ev?"Compliance: issues found — jump to details":"Compliance: OK — jump to details",children:[ev?(0,a.jsx)(R.Z,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4 shrink-0"}):(0,a.jsx)(E.Z,{className:"w-3.5 h-3.5 sm:w-4 sm:h-4 shrink-0"}),(0,a.jsx)("span",{children:"Compliance"}),(0,a.jsx)("span",{className:"font-medium",children:ev?"Issues":"OK"})]})]})}),eI.isError&&(null===(r=eI.error.body)||void 0===r?void 0:r.code)==="PREVIOUS_WEEK_INCOMPLETE"&&(0,a.jsxs)("div",{className:"mb-4 rounded-xl border border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/30 p-4 flex flex-wrap items-center justify-between gap-2",children:[(0,a.jsx)("p",{className:"text-sm text-amber-800",children:eI.error instanceof Error?eI.error.message:"Save failed."}),(null===(m=eI.error.body)||void 0===m?void 0:m.sheet_id)&&(0,a.jsx)(o.default,{href:"/sheets/".concat(eI.error.body.sheet_id),children:(0,a.jsx)(u.z,{variant:"outline",size:"sm",className:"border-amber-300 dark:border-amber-700 text-amber-800 dark:text-amber-200 hover:bg-amber-100 dark:hover:bg-amber-900/50",children:"Open that sheet"})})]}),(0,a.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6",children:[(0,a.jsxs)("div",{ref:el,className:"flex-1 space-y-4",children:[(0,a.jsx)(K.E.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-4 md:p-5",children:(0,a.jsx)(q,{sheetData:v,onChange:eO})}),v.days.map((e,t)=>(0,a.jsx)("div",{className:"completed"!==v.status?"scroll-mt-48":"scroll-mt-6",children:(0,a.jsx)(ee,{dayIndex:t,dayData:e,onUpdate:eF,weekStart:v.week_starting,regos:ex})},t))]}),(0,a.jsx)("div",{id:"compliance-check",className:"w-full lg:w-80 shrink-0 scroll-mt-24",children:(0,a.jsxs)("div",{className:"lg:sticky lg:top-6 space-y-4",children:[(0,a.jsxs)(K.E.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},className:"bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm p-4",children:[(0,a.jsx)("h2",{className:"text-sm font-bold text-slate-700 dark:text-slate-200 mb-3 uppercase tracking-wider",children:"Compliance Check"}),(0,a.jsx)(em,{days:v.days,driverType:v.driver_type,prevWeekDays:(null==ef?void 0:ef.days)||null,last24hBreak:v.last_24h_break||void 0,weekStarting:v.week_starting||void 0,prevWeekStarting:null!==(x=null==ef?void 0:ef.week_starting)&&void 0!==x?x:void 0,complianceResults:null!==(f=null==ek?void 0:ek.results)&&void 0!==f?f:null,complianceLoading:eb})]}),v.signature&&(0,a.jsxs)(K.E.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-white dark:bg-slate-900 rounded-xl border border-emerald-200 dark:border-emerald-800 shadow-sm p-4",children:[(0,a.jsxs)("h2",{className:"text-sm font-bold text-slate-700 dark:text-slate-200 mb-2 uppercase tracking-wider flex items-center gap-1.5",children:[(0,a.jsx)(E.Z,{className:"w-4 h-4 text-emerald-500"})," Driver Signature"]}),(0,a.jsx)("div",{className:"border border-slate-200 dark:border-slate-600 rounded-lg overflow-hidden bg-slate-50 dark:bg-slate-800",children:(0,a.jsx)("img",{src:v.signature,alt:"Driver signature",className:"w-full h-auto"})}),v.signed_at&&(0,a.jsxs)("p",{className:"text-[10px] text-slate-400 mt-1.5",children:["Signed"," ",new Date(v.signed_at).toLocaleString("en-AU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1})]})]})]})})]})]}),(0,a.jsx)(eg,{open:F,onConfirm:e=>{let t=new Date().toISOString();U(r=>({...r,status:"completed",signature:e,signed_at:t})),V(!1),eI.mutate({driver_name:v.driver_name,second_driver:v.second_driver,driver_type:v.driver_type,destination:v.destination,last_24h_break:v.last_24h_break||void 0,week_starting:v.week_starting,days:v.days,status:"completed",signature:e,signed_at:t})},onCancel:()=>V(!1),driverName:v.driver_name}),(0,a.jsx)(k,{open:!!X,onOpenChange:e=>!e&&J(null),children:(0,a.jsxs)(w,{className:"sm:max-w-sm",children:[(0,a.jsxs)(y,{children:[(0,a.jsxs)(j,{className:"flex items-center gap-2",children:[(0,a.jsx)(z.Z,{className:"w-5 h-5"}),"End shift"]}),(0,a.jsx)(N,{children:"Enter end odometer. This will log End Shift for today and switch to non-work time. Start km and end km are required; end km must not be lower than any previous entry for this rego."})]}),(0,a.jsxs)("div",{className:"space-y-3 pt-1",children:[(0,a.jsx)(M._,{htmlFor:"end-shift-kms",className:"text-xs font-semibold text-slate-500 dark:text-slate-400",children:"End km (required)"}),(0,a.jsx)(_.I,{id:"end-shift-kms",type:"number",min:0,placeholder:"e.g. 12345",value:$,onChange:e=>{G(e.target.value),er(null)},className:"font-mono","aria-invalid":!!et,"aria-describedby":et?"end-shift-error":void 0}),et&&(0,a.jsx)("p",{id:"end-shift-error",className:"text-xs text-red-600 dark:text-red-400",role:"alert",children:et}),(0,a.jsxs)("div",{className:"flex gap-2 justify-end pt-2",children:[(0,a.jsx)(u.z,{variant:"outline",size:"sm",onClick:()=>J(null),children:"Cancel"}),(0,a.jsxs)(u.z,{size:"sm",onClick:eQ,className:"gap-1.5",children:[(0,a.jsx)(z.Z,{className:"w-3.5 h-3.5"}),"End shift"]})]})]})]})})]})}},2513:function(e,t,r){"use strict";r.d(t,{F:function(){return c},f:function(){return d}});var a=r(7437),n=r(2265);let s="fatigue-theme",l=(0,n.createContext)(null);function i(){return window.matchMedia("(prefers-color-scheme: dark)").matches}function o(e){let t=document.documentElement;e?t.classList.add("dark"):t.classList.remove("dark")}function d(e){let{children:t}=e,[r,d]=(0,n.useState)("system"),[c,u]=(0,n.useState)("light"),[m,h]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{h(!0);let e=localStorage.getItem(s);e&&("light"===e||"dark"===e||"system"===e)&&d(e)},[]),(0,n.useEffect)(()=>{if(!m)return;let e="system"===r?i():"dark"===r;u(e?"dark":"light"),o(e)},[r,m]),(0,n.useEffect)(()=>{if(!m)return;let e=window.matchMedia("(prefers-color-scheme: dark)"),t=()=>{if("system"===r){let e=i();u(e?"dark":"light"),o(e)}};return e.addEventListener("change",t),()=>e.removeEventListener("change",t)},[r,m]),(0,a.jsx)(l.Provider,{value:{theme:r,setTheme:e=>{d(e),localStorage.setItem(s,e);let t="system"===e?i():"dark"===e;u(t?"dark":"light"),o(t)},resolved:c},children:t})}function c(){let e=(0,n.useContext)(l);if(!e)throw Error("useTheme must be used within ThemeProvider");return e}},9547:function(e,t,r){"use strict";r.d(t,{T:function(){return o}});var a=r(7437);r(2265);var n=r(595),s=r(572),l=r(2513),i=r(2381);function o(){let{resolved:e,setTheme:t}=(0,l.F)();return(0,a.jsx)(i.z,{variant:"ghost",size:"icon",className:"h-11 w-11 rounded-lg text-slate-600 hover:bg-slate-100 hover:text-slate-900 dark:text-slate-400 dark:hover:bg-slate-800 dark:hover:text-slate-100",onClick:()=>t("dark"===e?"light":"dark"),title:"dark"===e?"Switch to light mode":"Switch to dark mode","aria-label":"dark"===e?"Switch to light mode":"Switch to dark mode",children:"dark"===e?(0,a.jsx)(n.Z,{className:"h-6 w-6"}):(0,a.jsx)(s.Z,{className:"h-6 w-6"})})}},2381:function(e,t,r){"use strict";r.d(t,{z:function(){return o}});var a=r(7437),n=r(2265),s=r(535),l=r(3448);let i=(0,s.j)("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",{variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",outline:"border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground",ghost:"hover:bg-accent hover:text-accent-foreground"},size:{default:"h-9 px-4 py-2",sm:"h-8 rounded-md px-3 text-xs",icon:"h-9 w-9"}},defaultVariants:{variant:"default",size:"default"}}),o=n.forwardRef((e,t)=>{let{className:r,variant:n,size:s,...o}=e;return(0,a.jsx)("button",{className:(0,l.cn)(i({variant:n,size:s,className:r})),ref:t,...o})});o.displayName="Button"},279:function(e,t,r){"use strict";r.d(t,{I:function(){return l}});var a=r(7437),n=r(2265),s=r(3448);let l=n.forwardRef((e,t)=>{let{className:r,type:n,...l}=e;return(0,a.jsx)("input",{type:n,className:(0,s.cn)("flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...l})});l.displayName="Input"},5060:function(e,t,r){"use strict";r.d(t,{_:function(){return l}});var a=r(7437),n=r(2265),s=r(3448);let l=n.forwardRef((e,t)=>{let{className:r,...n}=e;return(0,a.jsx)("label",{ref:t,className:(0,s.cn)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",r),...n})});l.displayName="Label"},5291:function(e,t,r){"use strict";r.d(t,{Bw:function(){return u},Ph:function(){return d},Ql:function(){return m},i4:function(){return c},ki:function(){return h}});var a=r(7437),n=r(2265),s=r(861),l=r(3289),i=r(9559),o=r(3448);let d=s.fC,c=n.forwardRef((e,t)=>{let{className:r,children:n,...i}=e;return(0,a.jsxs)(s.xz,{ref:t,className:(0,o.cn)("flex h-9 w-full items-center justify-between rounded-md border border-input bg-transparent px-3 py-2 text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-ring disabled:opacity-50 [&>span]:line-clamp-1",r),...i,children:[n,(0,a.jsx)(s.JO,{asChild:!0,children:(0,a.jsx)(l.Z,{className:"h-4 w-4 opacity-50"})})]})});c.displayName=s.xz.displayName;let u=n.forwardRef((e,t)=>{let{className:r,children:n,position:l="popper",...i}=e;return(0,a.jsx)(s.h_,{children:(0,a.jsx)(s.VY,{ref:t,className:(0,o.cn)("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800 text-slate-900 dark:text-slate-100 shadow-md",r),position:l,...i,children:(0,a.jsx)(s.l_,{className:"p-1",children:n})})})});u.displayName=s.VY.displayName;let m=n.forwardRef((e,t)=>{let{className:r,children:n,...l}=e;return(0,a.jsxs)(s.ck,{ref:t,className:(0,o.cn)("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-2 pr-8 text-sm outline-none focus:bg-slate-100 dark:focus:bg-slate-700 data-[disabled]:pointer-events-none data-[disabled]:opacity-50",r),...l,children:[(0,a.jsx)("span",{className:"absolute right-2 flex h-3.5 w-3.5 items-center justify-center",children:(0,a.jsx)(s.wU,{children:(0,a.jsx)(i.Z,{className:"h-4 w-4"})})}),(0,a.jsx)(s.eT,{children:n})]})});m.displayName=s.ck.displayName;let h=s.B4},3448:function(e,t,r){"use strict";r.d(t,{cn:function(){return s}});var a=r(1994),n=r(3335);function s(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,n.m6)((0,a.W)(t))}}},function(e){e.O(0,[851,21,648,91,71,180,586,971,117,744],function(){return e(e.s=2996)}),_N_E=e.O()}]);